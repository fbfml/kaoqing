<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è€ƒå‹¤ç³»ç»Ÿ | ç®€åŒ–ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --rest-day-color: #95a5a6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        header {
            background: linear-gradient(135deg, var(--primary-color), #1a252f);
            color: white;
            padding: 30px 40px;
            border-bottom: 4px solid var(--secondary-color);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .current-date {
            font-size: 16px;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
        }
        
        /* æ¨¡å—å¯¼èˆª */
        .module-nav {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 5px;
            margin-top: 15px;
            overflow-x: auto;
        }
        
        .module-btn {
            flex-shrink: 0;
            padding: 15px 25px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }
        
        .module-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }
        
        .module-btn.active {
            background: white;
            color: var(--primary-color);
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* æ¨¡å—å†…å®¹ */
        .module-content {
            display: none;
            padding: 40px;
            animation: slideIn 0.5s ease;
        }
        
        .module-content.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ¨¡å—æ ‡é¢˜ */
        .module-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* åŠŸèƒ½å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        
        /* æ’ç­æ—¥å† */
        .calendar-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 15px;
            background: #e9ecef;
            font-weight: bold;
            color: var(--primary-color);
            border-radius: 8px;
        }
        
        .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day {
            min-height: 100px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .calendar-day:hover {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .calendar-day.today {
            border-color: var(--secondary-color);
            background: #e3f2fd;
        }
        
        .calendar-day.weekend {
            background: #f9f9f9;
        }
        
        .calendar-day.rest-day {
            background: #f0f8ff;
        }
        
        .day-number {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .rest-count {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            font-size: 12px;
            color: var(--rest-day-color);
            background: rgba(149, 165, 166, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        /* ä¼‘æ¯æ—¥è¯¦æƒ…å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        /* ä¼‘æ¯æ—¥è®¾ç½® */
        .week-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .day-selector {
            flex: 1;
            min-width: 80px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
        }
        
        .day-selector:hover {
            border-color: var(--secondary-color);
        }
        
        .day-selector.selected {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        /* è¯¦ç»†æ’ç­è¡¨ */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
        }
        
        .schedule-table th {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
        }
        
        .schedule-table td {
            padding: 18px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .schedule-table tr:hover {
            background: #f8f9fa;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            height: 400px;
            margin-top: 20px;
            position: relative;
        }
        
        /* æ•°æ®ç»Ÿè®¡å¡ç‰‡ */
        .stats-card {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.3);
        }
        
        .stat-number {
            font-size: 42px;
            font-weight: 800;
            margin: 15px 0;
        }
        
        .stat-label {
            font-size: 16px;
            opacity: 0.9;
        }
        
        /* è€ƒå‹¤ç±»å‹æ ‡ç­¾ */
        .attendance-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-late { background: #fff3cd; color: #856404; }
        .badge-early { background: #f8d7da; color: #721c24; }
        .badge-sick { background: #d1ecf1; color: #0c5460; }
        .badge-personal { background: #d6eaf8; color: #1b4f72; }
        .badge-annual { background: #e8daef; color: #4a235a; }
        .badge-absent { background: #e6b0aa; color: #78281f; }
        .badge-o-rest { background: #c8e6c9; color: #1b5e20; }
        .badge-b-rest { background: #b3e5fc; color: #01579b; }
        
        /* ç­›é€‰å™¨æ ·å¼ */
        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            min-width: 150px;
        }
        
        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .page-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .page-btn:hover {
            background: #f5f5f5;
        }
        
        .page-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                box-shadow: none;
            }
            
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .module-btn {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .module-content {
                padding: 20px;
            }
            
            .module-title {
                font-size: 24px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 8px;
            }
            
            .day-number {
                font-size: 16px;
            }
            
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-select {
                width: 100%;
            }
        }
        
        /* é¡µè„š */
        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
            background: #f8f9fa;
        }
        
        /* æ‰¹é‡æ“ä½œåŒºåŸŸ */
        .batch-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .batch-action-card {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        /* ç»Ÿè®¡è¡¨æ ¼æ ·å¼ */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .stats-table th, .stats-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .stats-table th {
            background: #f1f8ff;
            font-weight: 600;
        }
        
        .stats-table tr:hover {
            background: #f5f9ff;
        }
        
        /* æˆåŠŸæç¤º */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
            z-index: 1001;
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .success-message.fade-out {
            animation: slideOutRight 0.3s ease forwards;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ•°æ®çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .data-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #f8f9fa;
            color: #666;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #95a5a6;
        }
        
        .status-indicator.saved {
            background: #27ae60;
        }
        
        .status-indicator.unsaved {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div>
                    <h1>ğŸ¢ æ™ºèƒ½è€ƒå‹¤ç³»ç»Ÿ</h1>
                    <p style="opacity: 0.8;">ç®€åŒ–ç‰ˆ | æœ¬åœ°è¿è¡Œ | ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½</p>
                </div>
                <div class="current-date" id="currentDate"></div>
            </div>
            
            <div class="module-nav">
                <button class="module-btn active" data-module="dashboard">
                    ğŸ“Š ä»ªè¡¨ç›˜
                </button>
                <button class="module-btn" data-module="team">
                    ğŸ‘¥ å›¢é˜Ÿç®¡ç†
                </button>
                <button class="module-btn" data-module="schedule">
                    ğŸ“… æ’ç­è®¾ç½®
                </button>
                <button class="module-btn" data-module="attendance">
                    âœ… è€ƒå‹¤è®°å½•
                </button>
                <button class="module-btn" data-module="history">
                    ğŸ“œ è€ƒå‹¤å†å²
                </button>
                <button class="module-btn" data-module="statistics">
                    ğŸ“ˆ æ•°æ®ç»Ÿè®¡
                </button>
            </div>
        </header>
        
        <!-- ä»ªè¡¨ç›˜æ¨¡å— -->
        <div id="dashboard" class="module-content active">
            <div class="module-title">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</div>
            
            <div class="grid-3">
                <div class="stats-card">
                    <div class="stat-label">å›¢é˜Ÿæˆå‘˜</div>
                    <div class="stat-number" id="totalMembers">0</div>
                    <div class="stat-label">è´Ÿè´£äºº: <span id="leaderCount">0</span>äºº</div>
                </div>
                
                <div class="stats-card" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                    <div class="stat-label">ä»Šæ—¥å‡ºå‹¤ç‡</div>
                    <div class="stat-number" id="todayAttendanceRate">0%</div>
                    <div class="stat-label">å®é™…å‡ºå‹¤: <span id="checkedToday">0</span>äºº</div>
                </div>
                
                <div class="stats-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                    <div class="stat-label">æœ¬æœˆå¼‚å¸¸</div>
                    <div class="stat-number" id="monthExceptionCount">0</div>
                    <div class="stat-label">è¿Ÿåˆ°/æ—©é€€/ç¼ºå‹¤</div>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-title">ğŸ“ˆ ä»Šæ—¥å‡ºå‹¤æƒ…å†µ</div>
                    <div class="chart-container">
                        <canvas id="todayChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">ğŸ‘¥ å·¥åºå‡ºå‹¤å¯¹æ¯”</div>
                    <div class="chart-container">
                        <canvas id="processChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å›¢é˜Ÿç®¡ç†æ¨¡å— -->
        <div id="team" class="module-content">
            <div class="module-title">ğŸ‘¥ å›¢é˜Ÿç®¡ç†</div>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-title">â• æ·»åŠ /ç¼–è¾‘æˆå‘˜</div>
                    <form id="memberForm">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px;">
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">å§“å</label>
                                <input type="text" id="memberName" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" placeholder="è¾“å…¥å§“å" required>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">å·¥å·</label>
                                <input type="text" id="memberCode" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" placeholder="è¾“å…¥å·¥å·" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px;">
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">å·¥åº</label>
                                <select id="memberProcess" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" required>
                                    <option value="">é€‰æ‹©å·¥åº</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">è§’è‰²</label>
                                <select id="memberRole" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" required>
                                    <option value="">é€‰æ‹©è§’è‰²</option>
                                    <option value="è´Ÿè´£äºº">è´Ÿè´£äºº</option>
                                    <option value="ç»„å‘˜">ç»„å‘˜</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            ğŸ’¾ ä¿å­˜æˆå‘˜ä¿¡æ¯
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-title">ğŸ“‹ æˆå‘˜åˆ—è¡¨ (å…±<span id="memberCount">0</span>äºº)</div>
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="searchMember" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" placeholder="æœç´¢å§“åã€å·¥å·æˆ–å·¥åº...">
                    </div>
                    <div id="memberList"></div>
                </div>
            </div>
        </div>
        
        <!-- æ’ç­è®¾ç½®æ¨¡å— -->
        <div id="schedule" class="module-content">
            <div class="module-title">ğŸ“… æ’ç­è®¾ç½®</div>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-title">ğŸ‘¤ ä¸ªäººä¼‘æ¯æ—¥è®¾ç½®</div>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">é€‰æ‹©æˆå‘˜</label>
                        <select id="scheduleMemberSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" onchange="loadMemberRestDays()">
                            <option value="">è¯·é€‰æ‹©æˆå‘˜</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">è®¾ç½®æ¯å‘¨ä¼‘æ¯æ—¥</label>
                        <div class="week-selector">
                            <div class="day-selector" data-day="0" onclick="toggleRestDay(0)">å‘¨æ—¥</div>
                            <div class="day-selector" data-day="1" onclick="toggleRestDay(1)">å‘¨ä¸€</div>
                            <div class="day-selector" data-day="2" onclick="toggleRestDay(2)">å‘¨äºŒ</div>
                            <div class="day-selector" data-day="3" onclick="toggleRestDay(3)">å‘¨ä¸‰</div>
                            <div class="day-selector" data-day="4" onclick="toggleRestDay(4)">å‘¨å››</div>
                            <div class="day-selector" data-day="5" onclick="toggleRestDay(5)">å‘¨äº”</div>
                            <div class="day-selector" data-day="6" onclick="toggleRestDay(6)">å‘¨å…­</div>
                        </div>
                    </div>
                    
                    <button onclick="saveMemberSchedule()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        ğŸ’¾ ä¿å­˜æ’ç­è®¾ç½®
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-title">ğŸ“… æœ¬æœˆæ’ç­æ—¥å†</div>
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-day-header">æ—¥</div>
                            <div class="calendar-day-header">ä¸€</div>
                            <div class="calendar-day-header">äºŒ</div>
                            <div class="calendar-day-header">ä¸‰</div>
                            <div class="calendar-day-header">å››</div>
                            <div class="calendar-day-header">äº”</div>
                            <div class="calendar-day-header">å…­</div>
                        </div>
                        <div class="calendar-body" id="calendarBody"></div>
                    </div>
                    <div style="margin-top: 15px; color: #666; font-size: 14px; text-align: center;">
                        ç‚¹å‡»æ—¥æœŸæŸ¥çœ‹å½“å¤©ä¼‘æ¯äººå‘˜
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ“‹ è¯¦ç»†æ’ç­è¡¨</div>
                <div style="margin-bottom: 20px; color: #666;">
                    æ‰€æœ‰æˆå‘˜çš„æ¯å‘¨ä¼‘æ¯æ—¥å®‰æ’ï¼Œç‚¹å‡»æˆå‘˜å¯ä»¥å¿«é€Ÿè®¾ç½®ã€‚
                </div>
                <div id="detailedScheduleTable"></div>
            </div>
        </div>
        
        <!-- è€ƒå‹¤è®°å½•æ¨¡å— -->
        <div id="attendance" class="module-content">
            <div class="module-title">âœ… è€ƒå‹¤è®°å½•</div>
            
            <div class="grid-2">
                <div class="card">
                    <div class="card-title">â° è®°å½•è€ƒå‹¤</div>
                    <form id="attendanceForm">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px;">
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">é€‰æ‹©æˆå‘˜</label>
                                <select id="attendanceMember" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" required>
                                    <option value="">è¯·é€‰æ‹©æˆå‘˜</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">è€ƒå‹¤æ—¥æœŸ</label>
                                <input type="date" id="attendanceDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" required>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">è€ƒå‹¤ç±»å‹</label>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="attendanceType" value="late" checked> è¿Ÿåˆ°
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="attendanceType" value="leave_early"> æ—©é€€
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="attendanceType" value="sick_leave"> ç—…å‡
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="attendanceType" value="personal_leave"> äº‹å‡
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="attendanceType" value="annual_leave"> å¹´å‡
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="attendanceType" value="absent"> ç¼ºå‹¤
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="attendanceType" value="o_rest"> Oç­ä¼‘æ¯
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                    <input type="radio" name="attendanceType" value="b_rest"> Bç­ä¼‘æ¯
                                </label>
                            </div>
                        </div>
                        
                        <div id="leaveDetails" style="display: none; margin-bottom: 25px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">è¯·å‡æ—¶é•¿(å°æ—¶)</label>
                                    <input type="number" id="leaveDuration" min="0.5" step="0.5" value="8" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">è¯·å‡äº‹ç”±</label>
                                    <input type="text" id="leaveReason" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" placeholder="è¯·è¾“å…¥è¯·å‡äº‹ç”±">
                                </div>
                            </div>
                        </div>
                        
                        <div id="earlyDetails" style="display: none; margin-bottom: 25px;">
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">å®é™…ä¸‹ç­æ—¶é—´</label>
                                <input type="time" id="actualOffTime" value="19:00" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" onchange="calculateEarlyLeave()">
                                <div id="earlyResult" style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 6px; color: #721c24; display: none;">
                                    æ—©é€€ <span id="earlyHours">0</span> å°æ—¶
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            ğŸ’¾ æäº¤è€ƒå‹¤è®°å½•
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-title">ğŸ“… ä»Šæ—¥è€ƒå‹¤æƒ…å†µ</div>
                    <div style="margin-bottom: 20px; color: #666;">
                        ä»Šæ—¥æœ‰ <span id="todayRecordCount" style="font-weight: 600;">0</span> æ¡è€ƒå‹¤è®°å½•ï¼ˆæ­£å¸¸å‡ºå‹¤ä¸æ˜¾ç¤ºï¼‰
                        <span class="data-status" style="float: right; margin-top: 5px;">
                            æ•°æ®çŠ¶æ€: <span class="status-indicator" id="dataStatus"></span>
                        </span>
                    </div>
                    <div id="todayAttendanceList"></div>
                </div>
            </div>
        </div>
        
        <!-- è€ƒå‹¤å†å²æ¨¡å— -->
        <div id="history" class="module-content">
            <div class="module-title">ğŸ“œ è€ƒå‹¤å†å²æ•°æ®</div>
            
            <div class="card">
                <div class="card-title">ğŸ” å†å²æ•°æ®æŸ¥è¯¢ä¸ç¼–è¾‘</div>
                
                <div class="filter-container">
                    <select id="historyYear" class="filter-select" onchange="loadHistoryData()">
                        <option value="">é€‰æ‹©å¹´ä»½</option>
                    </select>
                    
                    <select id="historyMonth" class="filter-select" onchange="loadHistoryData()">
                        <option value="">é€‰æ‹©æœˆä»½</option>
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                    
                    <select id="historyProcess" class="filter-select" onchange="loadHistoryData()">
                        <option value="">é€‰æ‹©å·¥åº</option>
                    </select>
                    
                    <select id="historyType" class="filter-select" onchange="loadHistoryData()">
                        <option value="">é€‰æ‹©è€ƒå‹¤ç±»å‹</option>
                        <option value="late">è¿Ÿåˆ°</option>
                        <option value="leave_early">æ—©é€€</option>
                        <option value="sick_leave">ç—…å‡</option>
                        <option value="personal_leave">äº‹å‡</option>
                        <option value="annual_leave">å¹´å‡</option>
                        <option value="absent">ç¼ºå‹¤</option>
                        <option value="o_rest">Oç­ä¼‘æ¯</option>
                        <option value="b_rest">Bç­ä¼‘æ¯</option>
                    </select>
                    
                    <button onclick="clearHistoryFilters()" class="action-btn btn-primary">æ¸…é™¤ç­›é€‰</button>
                    <button onclick="loadHistoryData(1)" class="action-btn btn-success">æŸ¥è¯¢æ•°æ®</button>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>å½“å‰ç­›é€‰ç»“æœï¼š</strong>
                            <span id="historyFilterSummary">å…¨éƒ¨è®°å½•</span>
                            <span class="data-status" style="margin-left: 20px;">
                                æ€»è®°å½•æ•°: <span id="totalRecordsCount">0</span> æ¡
                            </span>
                        </div>
                        <div>
                            <button onclick="deleteAllHistoryData()" class="action-btn btn-danger">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
                        </div>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>åºå·</th>
                                <th>æ—¥æœŸ</th>
                                <th>å§“å</th>
                                <th>å·¥å·</th>
                                <th>å·¥åº</th>
                                <th>è€ƒå‹¤ç±»å‹</th>
                                <th>æ—¶é•¿(å°æ—¶)</th>
                                <th>å¤‡æ³¨</th>
                                <th>è®°å½•æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                                    è¯·é€‰æ‹©ç­›é€‰æ¡ä»¶æˆ–ç‚¹å‡»"æŸ¥è¯¢æ•°æ®"æŸ¥çœ‹å†å²è®°å½•
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="historyPagination">
                    <button onclick="loadHistoryData(1)" class="page-btn">é¦–é¡µ</button>
                    <button onclick="prevHistoryPage()" class="page-btn">ä¸Šä¸€é¡µ</button>
                    <span id="historyPageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    <button onclick="nextHistoryPage()" class="page-btn">ä¸‹ä¸€é¡µ</button>
                    <button onclick="exportHistoryData()" class="action-btn btn-success">å¯¼å‡ºæ•°æ®</button>
                </div>
                
                <div class="batch-actions">
                    <div class="batch-action-card">
                        <h4>ğŸ“Š æ‰¹é‡å¯¼å…¥</h4>
                        <input type="file" id="importFile" accept=".json" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                        <button onclick="importHistoryData()" class="action-btn btn-primary" style="width: 100%;">
                            å¯¼å…¥JSONæ•°æ®
                        </button>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            æ”¯æŒJSONæ ¼å¼ï¼Œæ•°æ®ç»“æ„éœ€ä¸ç³»ç»Ÿä¸€è‡´
                        </p>
                    </div>
                    
                    <div class="batch-action-card">
                        <h4>ğŸ’¾ æ•°æ®å¤‡ä»½</h4>
                        <button onclick="backupHistoryData()" class="action-btn btn-success" style="width: 100%; margin-bottom: 10px;">
                            å¤‡ä»½å½“å‰æ•°æ®
                        </button>
                        <button onclick="restoreHistoryData()" class="action-btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                            æ¢å¤å¤‡ä»½æ•°æ®
                        </button>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            å¤‡ä»½æ–‡ä»¶å°†ä¿å­˜åˆ°æœ¬åœ°ï¼Œå»ºè®®å®šæœŸå¤‡ä»½
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®ç»Ÿè®¡æ¨¡å— -->
        <div id="statistics" class="module-content">
            <div class="module-title">ğŸ“ˆ æ•°æ®ç»Ÿè®¡åˆ†æ</div>
            
            <!-- ç¬¬ä¸€çº¬åº¦ï¼šæ—¥æœŸçº¬åº¦ - æ¯æ—¥å‡ºå‹¤äººæ•°å˜åŒ– -->
            <div class="card">
                <div class="card-title">ğŸ“… æ—¥æœŸçº¬åº¦ï¼šæ¯æ—¥å‡ºå‹¤äººæ•°å˜åŒ–</div>
                <div class="filter-container">
                    <select id="dateStatYear" class="filter-select" onchange="updateDateDimensionChart()">
                        <option value="">é€‰æ‹©å¹´ä»½</option>
                    </select>
                    <select id="dateStatMonth" class="filter-select" onchange="updateDateDimensionChart()">
                        <option value="">é€‰æ‹©æœˆä»½</option>
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                    <select id="dateStatProcess" class="filter-select" onchange="updateDateDimensionChart()">
                        <option value="all">å…¨éƒ¨å·¥åº</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="dateDimensionChart"></canvas>
                </div>
            </div>
            
            <!-- ç¬¬äºŒçº¬åº¦ï¼šå·¥åºçº¬åº¦ - å½“æœˆå„å·¥åºå‡ºå‹¤æ•°æ®å¯¹æ¯” -->
            <div class="card">
                <div class="card-title">ğŸ­ å·¥åºçº¬åº¦ï¼šå„å·¥åºå‡ºå‹¤æ•°æ®å¯¹æ¯”</div>
                <div class="filter-container">
                    <select id="processStatYear" class="filter-select" onchange="updateProcessDimensionChart()">
                        <option value="">é€‰æ‹©å¹´ä»½</option>
                    </select>
                    <select id="processStatMonth" class="filter-select" onchange="updateProcessDimensionChart()">
                        <option value="">é€‰æ‹©æœˆä»½</option>
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="processDimensionChart"></canvas>
                </div>
            </div>
            
            <!-- ç¬¬ä¸‰çº¬åº¦ï¼šæˆå‘˜çº¬åº¦ - å½“æœˆæˆå‘˜å‡ºå‹¤æƒ…å†µ -->
            <div class="card">
                <div class="card-title">ğŸ‘¤ æˆå‘˜çº¬åº¦ï¼šå½“æœˆæˆå‘˜å‡ºå‹¤æƒ…å†µ</div>
                <div class="filter-container">
                    <select id="memberStatYear" class="filter-select" onchange="updateMemberDimensionTable()">
                        <option value="">é€‰æ‹©å¹´ä»½</option>
                    </select>
                    <select id="memberStatMonth" class="filter-select" onchange="updateMemberDimensionTable()">
                        <option value="">é€‰æ‹©æœˆä»½</option>
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                    <select id="memberStatProcess" class="filter-select" onchange="updateMemberDimensionTable()">
                        <option value="all">å…¨éƒ¨å·¥åº</option>
                    </select>
                </div>
                <div style="overflow-x: auto; max-height: 500px; margin-top: 20px;">
                    <table class="stats-table" id="memberDimensionTable">
                        <thead>
                            <tr>
                                <th>å§“å</th>
                                <th>å·¥å·</th>
                                <th>å·¥åº</th>
                                <th>å‡ºå‹¤å¤©æ•°</th>
                                <th>è¿Ÿåˆ°æ¬¡æ•°</th>
                                <th>æ—©é€€æ¬¡æ•°</th>
                                <th>è¯·å‡æ¬¡æ•°</th>
                                <th>ä¼‘æ¯æ¬¡æ•°</th>
                                <th>å‡ºå‹¤ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="memberDimensionBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                                    è¯·é€‰æ‹©å¹´ä»½å’Œæœˆä»½æŸ¥çœ‹æˆå‘˜å‡ºå‹¤æƒ…å†µ
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ç¬¬å››çº¬åº¦ï¼šå¹´åº¦çº¬åº¦ - æ¯æœˆå‡ºå‹¤æƒ…å†µå¯¹æ¯” -->
            <div class="card">
                <div class="card-title">ğŸ“Š å¹´åº¦çº¬åº¦ï¼šæ¯æœˆå‡ºå‹¤æƒ…å†µå¯¹æ¯”</div>
                <div class="filter-container">
                    <select id="yearStatYear" class="filter-select" onchange="updateYearDimensionChart()">
                        <option value="">é€‰æ‹©å¹´ä»½</option>
                    </select>
                    <select id="yearStatMetric" class="filter-select" onchange="updateYearDimensionChart()">
                        <option value="attendance_rate">å‡ºå‹¤ç‡</option>
                        <option value="late_count">è¿Ÿåˆ°æ¬¡æ•°</option>
                        <option value="leave_early_count">æ—©é€€æ¬¡æ•°</option>
                        <option value="leave_count">è¯·å‡æ¬¡æ•°</option>
                        <option value="rest_count">ä¼‘æ¯æ¬¡æ•°</option>
                        <option value="absent_count">ç¼ºå‹¤æ¬¡æ•°</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="yearDimensionChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- ä¼‘æ¯æ—¥è¯¦æƒ…å¼¹çª— -->
        <div class="modal-overlay" id="restDayModal">
            <div class="modal-content">
                <div class="modal-title" id="modalTitle"></div>
                <div id="restDayList"></div>
                <button onclick="closeRestDayModal()" style="width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 20px;">
                    å…³é—­
                </button>
            </div>
        </div>
        
        <!-- ç¼–è¾‘å†å²è®°å½•å¼¹çª— -->
        <div class="modal-overlay" id="editHistoryModal">
            <div class="modal-content">
                <div class="modal-title">ç¼–è¾‘è€ƒå‹¤è®°å½•</div>
                <form id="editHistoryForm">
                    <input type="hidden" id="editRecordId">
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px;">
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">é€‰æ‹©æˆå‘˜</label>
                            <select id="editMember" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" required>
                                <option value="">è¯·é€‰æ‹©æˆå‘˜</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">è€ƒå‹¤æ—¥æœŸ</label>
                            <input type="date" id="editDate" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" required>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">è€ƒå‹¤ç±»å‹</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="editAttendanceType" value="late"> è¿Ÿåˆ°
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="editAttendanceType" value="leave_early"> æ—©é€€
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="editAttendanceType" value="sick_leave"> ç—…å‡
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="editAttendanceType" value="personal_leave"> äº‹å‡
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="editAttendanceType" value="annual_leave"> å¹´å‡
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="editAttendanceType" value="absent"> ç¼ºå‹¤
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="editAttendanceType" value="o_rest"> Oç­ä¼‘æ¯
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="editAttendanceType" value="b_rest"> Bç­ä¼‘æ¯
                            </label>
                        </div>
                    </div>
                    
                    <div id="editLeaveDetails" style="display: none; margin-bottom: 25px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">è¯·å‡æ—¶é•¿(å°æ—¶)</label>
                                <input type="number" id="editLeaveDuration" min="0.5" step="0.5" value="8" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 10px; font-weight: 600;">è¯·å‡äº‹ç”±</label>
                                <input type="text" id="editLeaveReason" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" placeholder="è¯·è¾“å…¥è¯·å‡äº‹ç”±">
                            </div>
                        </div>
                    </div>
                    
                    <div id="editEarlyDetails" style="display: none; margin-bottom: 25px;">
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">å®é™…ä¸‹ç­æ—¶é—´</label>
                            <input type="time" id="editActualOffTime" value="19:00" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;" onchange="calculateEditEarlyLeave()">
                            <div id="editEarlyResult" style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 6px; color: #721c24; display: none;">
                                æ—©é€€ <span id="editEarlyHours">0</span> å°æ—¶
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            ä¿å­˜ä¿®æ”¹
                        </button>
                        <button type="button" onclick="closeEditModal()" style="flex: 1; padding: 14px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <footer>
            <p>Â© 2023 æ™ºèƒ½è€ƒå‹¤ç³»ç»Ÿ | ç®€åŒ–ç‰ˆ | æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œè¯·å®šæœŸå¤‡ä»½</p>
            <p style="font-size: 12px; margin-top: 5px;">ç­æ¬¡è®¾ç½®ï¼š08:00 - 20:00 | æ•°æ®æ›´æ–°æ—¶é—´ï¼š<span id="lastUpdate"></span></p>
            <p style="font-size: 12px; margin-top: 5px; color: #3498db;">
                <span class="data-status">
                    æ•°æ®çŠ¶æ€: <span class="status-indicator" id="footerDataStatus"></span>
                    å½“å‰å­˜å‚¨è®°å½•: <span id="storageRecordCount">0</span> æ¡
                </span>
            </p>
        </footer>
    </div>

    <script>
        // ==================== ç³»ç»Ÿåˆå§‹åŒ– ====================
        const DateTime = luxon.DateTime;
        
        // æ•°æ®å­˜å‚¨
        let teamMembers = [];
        let attendanceRecords = [];
        let memberSchedules = {};
        let processes = [];
        let historyBackup = [];
        
        // ç­æ¬¡é…ç½®ï¼ˆå›ºå®šä¸º08:00-20:00ï¼‰
        const SHIFT_CONFIG = {
            startTime: '08:00',
            endTime: '20:00',
            earlyThreshold: '20:00' // 20:00å‰ä¸‹ç­ç®—æ—©é€€
        };
        
        // å†å²è®°å½•åˆ†é¡µ
        let currentHistoryPage = 1;
        const historyPageSize = 20;
        let filteredHistoryRecords = [];
        
        // æ•°æ®çŠ¶æ€è·Ÿè¸ª
        let dataSaved = true;
        
        // å›¾è¡¨å®ä¾‹
        let dateDimensionChart = null;
        let processDimensionChart = null;
        let yearDimensionChart = null;
        let todayChartInstance = null;
        let processChartInstance = null;
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initSystem() {
            console.log('ğŸ”§ åˆå§‹åŒ–è€ƒå‹¤ç³»ç»Ÿ...');
            
            // å°è¯•ä»localStorageåŠ è½½æ•°æ®ï¼Œå¤„ç†å¯èƒ½çš„è§£æé”™è¯¯
            try {
                const teamData = localStorage.getItem('team_members');
                const attendanceData = localStorage.getItem('attendance_records');
                const scheduleData = localStorage.getItem('member_schedules');
                const processData = localStorage.getItem('processes');
                const backupData = localStorage.getItem('history_backup');
                
                teamMembers = teamData ? JSON.parse(teamData) : [];
                attendanceRecords = attendanceData ? JSON.parse(attendanceData) : [];
                memberSchedules = scheduleData ? JSON.parse(scheduleData) : {};
                processes = processData ? JSON.parse(processData) : [];
                historyBackup = backupData ? JSON.parse(backupData) : [];
                
                // éªŒè¯æ•°æ®ç»“æ„
                if (!Array.isArray(teamMembers)) teamMembers = [];
                if (!Array.isArray(attendanceRecords)) attendanceRecords = [];
                if (!memberSchedules || typeof memberSchedules !== 'object') memberSchedules = {};
                if (!Array.isArray(processes)) processes = [];
                if (!Array.isArray(historyBackup)) historyBackup = [];
                
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
                teamMembers = [];
                attendanceRecords = [];
                memberSchedules = {};
                processes = ['AEFå·¥åº', 'FEFå·¥åº', 'PIEFå·¥åº', 'PKGå·¥åº', 'RFå·¥åº', 'TWFå·¥åº'];
                historyBackup = [];
                
                // æ¸…é™¤å¯èƒ½æŸåçš„æ•°æ®
                localStorage.removeItem('team_members');
                localStorage.removeItem('attendance_records');
                localStorage.removeItem('member_schedules');
                localStorage.removeItem('processes');
                localStorage.removeItem('history_backup');
            }
            
            // åˆå§‹åŒ–å·¥åºæ•°æ®
            if (processes.length === 0) {
                processes = ['AEFå·¥åº', 'FEFå·¥åº', 'PIEFå·¥åº', 'PKGå·¥åº', 'RFå·¥åº', 'TWFå·¥åº'];
            }
            
            // åˆå§‹åŒ–é»˜è®¤å›¢é˜Ÿæˆå‘˜æ•°æ®ï¼ˆå¦‚æœä¸ºç©ºï¼‰
            if (teamMembers.length === 0) {
                const defaultMembers = [
                    { id: 1, name: 'è‘£æ¾', code: '80024794', process: 'AEFå·¥åº', role: 'è´Ÿè´£äºº' },
                    { id: 2, name: 'å‘¨æ–‡åº†', code: '80002840', process: 'AEFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 3, name: 'å”å¿—æ°', code: '80024944', process: 'AEFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 4, name: 'èƒ¡é¡º', code: '80028869', process: 'AEFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 5, name: 'éƒ­å‡¤ç§‹', code: '80002820', process: 'FEFå·¥åº', role: 'è´Ÿè´£äºº' },
                    { id: 6, name: 'çŸ³æ¢¦å®‡', code: '80028911', process: 'FEFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 7, name: 'æˆ´è´µæ˜', code: '80029224', process: 'FEFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 8, name: 'èƒ¥å½©æ˜', code: '80032338', process: 'FEFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 9, name: 'æœ±æ±Ÿå', code: '80027679', process: 'PIEFå·¥åº', role: 'è´Ÿè´£äºº' },
                    { id: 10, name: 'é›·å®‡æ°', code: '80019145', process: 'PIEFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 11, name: 'é©¬æœ¬æµ©', code: '80030101', process: 'PIEFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 12, name: 'è«ä¿Šæ°', code: '80031536', process: 'PIEFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 13, name: 'æ²ˆé”', code: '80026136', process: 'PKGå·¥åº', role: 'è´Ÿè´£äºº' },
                    { id: 14, name: 'å´æ˜Š', code: '80028755', process: 'PKGå·¥åº', role: 'ç»„å‘˜' },
                    { id: 15, name: 'èƒ¡æŸ', code: '80028868', process: 'PKGå·¥åº', role: 'ç»„å‘˜' },
                    { id: 16, name: 'æ¢æ¡¦', code: '80034426', process: 'PKGå·¥åº', role: 'ç»„å‘˜' },
                    { id: 17, name: 'é»„å®—å‘', code: '80034625', process: 'PKGå·¥åº', role: 'ç»„å‘˜' },
                    { id: 18, name: 'é™ˆå¯æº', code: '80025674', process: 'RFå·¥åº', role: 'è´Ÿè´£äºº' },
                    { id: 19, name: 'èƒ¡å¿—è±ª', code: '80004907', process: 'RFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 20, name: 'èµ–å«å‘', code: '80026640', process: 'RFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 21, name: 'é­æ—­ä¸œ', code: '80028492', process: 'RFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 22, name: 'å§œè¶…', code: '80026887', process: 'TWFå·¥åº', role: 'è´Ÿè´£äºº' },
                    { id: 23, name: 'å®¿èƒœåˆ©', code: '80028057', process: 'TWFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 24, name: 'ä»£é¾™å¯Œ', code: '80029316', process: 'TWFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 25, name: 'èµµé¾™', code: '80029219', process: 'TWFå·¥åº', role: 'ç»„å‘˜' },
                    { id: 26, name: 'å•æŸé¢–', code: '80035002', process: 'TWFå·¥åº', role: 'ç»„å‘˜' }
                ];
                
                teamMembers = defaultMembers;
            }
            
            // åˆå§‹åŒ–æˆå‘˜æ’ç­è®¾ç½®
            teamMembers.forEach(member => {
                if (!memberSchedules[member.id]) {
                    memberSchedules[member.id] = {
                        restDays: [], // æ¯å‘¨ä¼‘æ¯æ—¥ï¼Œ0=å‘¨æ—¥ï¼Œ1=å‘¨ä¸€ï¼Œ...ï¼Œ6=å‘¨å…­
                        notes: ''
                    };
                }
            });
            
            // ä¿å­˜åˆå§‹æ•°æ®
            saveAllData();
            updateDashboard();
            
            console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }
        
        // ==================== æˆåŠŸæç¤ºå’Œç•Œé¢æ›´æ–° ====================
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        function showSuccessMessage(message) {
            // ç§»é™¤å·²æœ‰çš„æç¤º
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // åˆ›å»ºæ–°çš„æç¤º
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.innerHTML = `
                <span>âœ“</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(successMessage);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                successMessage.classList.add('fade-out');
                setTimeout(() => {
                    if (successMessage.parentNode) {
                        successMessage.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // æ›´æ–°æ•°æ®çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateDataStatus() {
            const statusIndicator = document.getElementById('dataStatus');
            const footerStatusIndicator = document.getElementById('footerDataStatus');
            const storageRecordCount = document.getElementById('storageRecordCount');
            const totalRecordsCount = document.getElementById('totalRecordsCount');
            
            if (statusIndicator) {
                statusIndicator.className = dataSaved ? 'status-indicator saved' : 'status-indicator unsaved';
            }
            
            if (footerStatusIndicator) {
                footerStatusIndicator.className = dataSaved ? 'status-indicator saved' : 'status-indicator unsaved';
            }
            
            if (storageRecordCount) {
                storageRecordCount.textContent = attendanceRecords.length;
            }
            
            if (totalRecordsCount) {
                totalRecordsCount.textContent = attendanceRecords.length;
            }
        }
        
        // ==================== æ¨¡å—åˆ‡æ¢åŠŸèƒ½ ====================
        function switchModule(moduleId) {
            // æ›´æ–°æ¨¡å—æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.module-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-module') === moduleId) {
                    btn.classList.add('active');
                }
            });
            
            // æ›´æ–°æ¨¡å—å†…å®¹
            document.querySelectorAll('.module-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(moduleId).classList.add('active');
            
            // æ¨¡å—ç‰¹å®šçš„åˆå§‹åŒ–
            switch(moduleId) {
                case 'team':
                    loadProcessOptions();
                    renderMemberList();
                    break;
                case 'schedule':
                    loadMemberOptions();
                    renderCalendar();
                    renderDetailedScheduleTable();
                    break;
                case 'attendance':
                    loadMemberOptions('attendanceMember');
                    loadTodayAttendance();
                    break;
                case 'history':
                    initHistoryModule();
                    break;
                case 'statistics':
                    initStatisticsModule();
                    break;
            }
        }
        
        // åˆå§‹åŒ–æ¨¡å—å¯¼èˆª
        document.querySelectorAll('.module-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const moduleId = this.getAttribute('data-module');
                switchModule(moduleId);
            });
        });
        
        // ==================== å‡ºå‹¤ç‡è®¡ç®—è¾…åŠ©å‡½æ•° ====================
        // åˆ¤æ–­æ˜¯å¦ä¸ºæœªå‡ºå‹¤ç±»å‹ï¼ˆç¼ºå‹¤ã€è¯·å‡ã€ä¼‘æ¯ç­‰ï¼‰
        function isAbsentType(type) {
            return ['absent', 'sick_leave', 'personal_leave', 'annual_leave', 'o_rest', 'b_rest'].includes(type);
        }
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºè¿Ÿåˆ°/æ—©é€€ç±»å‹
        function isLateEarlyType(type) {
            return ['late', 'leave_early'].includes(type);
        }
        
        // è®¡ç®—æŒ‡å®šæ—¥æœŸçš„å‡ºå‹¤äººæ•°
        function calculateAttendanceForDate(dateStr, process = 'all') {
            // ç­›é€‰ç›¸å…³æˆå‘˜
            let relevantMembers = teamMembers;
            if (process !== 'all') {
                relevantMembers = teamMembers.filter(m => m.process === process);
            }
            
            const totalMembers = relevantMembers.length;
            
            // è·å–å½“å¤©çš„è€ƒå‹¤è®°å½•
            const dayRecords = attendanceRecords.filter(r => r.date === dateStr);
            
            // è®¡ç®—æœªå‡ºå‹¤äººæ•°ï¼šæœ‰è®°å½•ä¸”è®°å½•ç±»å‹ä¸ºæœªå‡ºå‹¤çš„äººæ•°
            const absentCount = dayRecords.filter(r => {
                const member = teamMembers.find(m => m.id === r.memberId);
                if (!member) return false;
                if (process !== 'all' && member.process !== process) return false;
                // åªæœ‰ç¼ºå‹¤ã€è¯·å‡ã€ä¼‘æ¯ç±»å‹ç®—ä½œæœªå‡ºå‹¤
                return isAbsentType(r.type);
            }).length;
            
            // å‡ºå‹¤äººæ•° = æ€»äººæ•° - æœªå‡ºå‹¤äººæ•°
            // æ²¡æœ‰è®°å½•æˆ–è®°å½•ä¸ºè¿Ÿåˆ°/æ—©é€€çš„éƒ½ç®—å‡ºå‹¤
            return totalMembers - absentCount;
        }
        
        // è®¡ç®—æŒ‡å®šæ—¥æœŸçš„å‡ºå‹¤ç‡
        function calculateAttendanceRateForDate(dateStr, process = 'all') {
            // ç­›é€‰ç›¸å…³æˆå‘˜
            let relevantMembers = teamMembers;
            if (process !== 'all') {
                relevantMembers = teamMembers.filter(m => m.process === process);
            }
            
            const totalMembers = relevantMembers.length;
            if (totalMembers === 0) return 0;
            
            const attendanceCount = calculateAttendanceForDate(dateStr, process);
            return (attendanceCount / totalMembers * 100).toFixed(1);
        }
        
        // ==================== ä»ªè¡¨ç›˜åŠŸèƒ½ ====================
        function updateDashboard() {
            const today = DateTime.now().toISODate();
            const now = DateTime.now();
            
            // æ›´æ–°å½“å‰æ—¥æœŸ
            document.getElementById('currentDate').textContent = 
                now.toLocaleString(DateTime.DATE_FULL) + ' ' + now.toLocaleString(DateTime.TIME_SIMPLE);
            document.getElementById('lastUpdate').textContent = now.toLocaleString(DateTime.DATETIME_SHORT);
            
            // æ›´æ–°å›¢é˜Ÿæˆå‘˜ç»Ÿè®¡
            const totalMembers = teamMembers.length;
            const leaderCount = teamMembers.filter(m => m.role === 'è´Ÿè´£äºº').length;
            document.getElementById('totalMembers').textContent = totalMembers;
            document.getElementById('leaderCount').textContent = leaderCount;
            
            // ä»Šæ—¥è€ƒå‹¤ç»Ÿè®¡
            const todayRecords = attendanceRecords.filter(r => r.date === today);
            
            // è®¡ç®—ä»Šæ—¥å‡ºå‹¤äººæ•°
            const attendanceToday = calculateAttendanceForDate(today, 'all');
            
            // è®¡ç®—å‡ºå‹¤ç‡
            const todayRate = totalMembers > 0 ? (attendanceToday / totalMembers * 100).toFixed(1) : 0;
            document.getElementById('todayAttendanceRate').textContent = todayRate + '%';
            document.getElementById('checkedToday').textContent = attendanceToday;
            
            // æœ¬æœˆå¼‚å¸¸ç»Ÿè®¡ï¼ˆè¿Ÿåˆ°+æ—©é€€+ç¼ºå‹¤ï¼‰
            const monthStart = now.startOf('month').toISODate();
            const monthEnd = now.endOf('month').toISODate();
            const monthRecords = attendanceRecords.filter(r => 
                r.date >= monthStart && r.date <= monthEnd
            );
            
            const exceptionCount = monthRecords.filter(r => 
                r.type === 'late' || r.type === 'leave_early' || r.type === 'absent'
            ).length;
            document.getElementById('monthExceptionCount').textContent = exceptionCount;
            
            // æ›´æ–°å›¾è¡¨
            updateTodayChart();
            updateProcessChart();
        }
        
        // æ›´æ–°ä»Šæ—¥å‡ºå‹¤å›¾è¡¨
        function updateTodayChart() {
            const ctx = document.getElementById('todayChart')?.getContext('2d');
            if (!ctx) return;
            
            const today = DateTime.now().toISODate();
            const todayRecords = attendanceRecords.filter(r => r.date === today);
            
            // ç»Ÿè®¡å„ç±»è€ƒå‹¤æ•°é‡
            const typeCounts = {
                'è¿Ÿåˆ°': todayRecords.filter(r => r.type === 'late').length,
                'æ—©é€€': todayRecords.filter(r => r.type === 'leave_early').length,
                'ç—…å‡': todayRecords.filter(r => r.type === 'sick_leave').length,
                'äº‹å‡': todayRecords.filter(r => r.type === 'personal_leave').length,
                'å¹´å‡': todayRecords.filter(r => r.type === 'annual_leave').length,
                'ç¼ºå‹¤': todayRecords.filter(r => r.type === 'absent').length,
                'Oç­ä¼‘æ¯': todayRecords.filter(r => r.type === 'o_rest').length,
                'Bç­ä¼‘æ¯': todayRecords.filter(r => r.type === 'b_rest').length
            };
            
            if (todayChartInstance) {
                todayChartInstance.destroy();
            }
            
            todayChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        data: Object.values(typeCounts),
                        backgroundColor: [
                            '#fff3cd', '#f8d7da', '#d1ecf1', 
                            '#d6eaf8', '#e8daef', '#e6b0aa',
                            '#c8e6c9', '#b3e5fc'
                        ],
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'ä»Šæ—¥è€ƒå‹¤åˆ†å¸ƒï¼ˆæ­£å¸¸å‡ºå‹¤ä¸æ˜¾ç¤ºï¼‰',
                            font: { size: 16 }
                        }
                    }
                }
            });
        }
        
        // æ›´æ–°å·¥åºå›¾è¡¨ï¼ˆä»ªè¡¨ç›˜ä¸­çš„ï¼‰
        function updateProcessChart() {
            const ctx = document.getElementById('processChart')?.getContext('2d');
            if (!ctx) return;
            
            const today = DateTime.now().toISODate();
            
            // ç»Ÿè®¡å„å·¥åºå‡ºå‹¤ç‡
            const processData = processes.map(process => {
                return parseFloat(calculateAttendanceRateForDate(today, process));
            });
            
            if (processChartInstance) {
                processChartInstance.destroy();
            }
            
            processChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: processes,
                    datasets: [{
                        label: 'ä»Šæ—¥å‡ºå‹¤ç‡ (%)',
                        data: processData,
                        backgroundColor: '#3498db',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'å„å·¥åºä»Šæ—¥å‡ºå‹¤ç‡å¯¹æ¯”',
                            font: { size: 16 }
                        }
                    }
                }
            });
        }
        
        // ==================== å›¢é˜Ÿç®¡ç†æ¨¡å— ====================
        // åŠ è½½å·¥åºé€‰é¡¹
        function loadProcessOptions(selectId = 'memberProcess') {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">é€‰æ‹©å·¥åº</option>';
            
            processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process;
                option.textContent = process;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // ä¿å­˜æˆå‘˜
        document.getElementById('memberForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const id = document.getElementById('memberId')?.value;
                const name = document.getElementById('memberName').value.trim();
                const code = document.getElementById('memberCode').value.trim();
                const process = document.getElementById('memberProcess').value;
                const role = document.getElementById('memberRole').value;
                
                if (!name || !code || !process || !role) {
                    alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼');
                    return;
                }
                
                // æ£€æŸ¥å·¥å·æ˜¯å¦é‡å¤
                const duplicate = teamMembers.find(m => m.code === code && m.id != id);
                if (duplicate) {
                    alert(`å·¥å· ${code} å·²è¢« ${duplicate.name} ä½¿ç”¨ï¼`);
                    return;
                }
                
                if (id) {
                    // ç¼–è¾‘ç°æœ‰æˆå‘˜
                    const index = teamMembers.findIndex(m => m.id == id);
                    teamMembers[index] = { id: parseInt(id), name, code, process, role };
                } else {
                    // æ–°å¢æˆå‘˜
                    const newId = teamMembers.length > 0 ? Math.max(...teamMembers.map(m => m.id)) + 1 : 1;
                    teamMembers.push({ id: newId, name, code, process, role });
                    
                    // åˆå§‹åŒ–æ’ç­è®¾ç½®
                    memberSchedules[newId] = {
                        restDays: [],
                        notes: ''
                    };
                }
                
                saveAllData();
                renderMemberList();
                loadMemberOptions();
                resetMemberForm();
                
                showSuccessMessage('æˆå‘˜ä¿¡æ¯ä¿å­˜æˆåŠŸï¼');
            } catch (error) {
                console.error('ä¿å­˜æˆå‘˜ä¿¡æ¯æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜æˆå‘˜ä¿¡æ¯æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        });
        
        // æ¸²æŸ“æˆå‘˜åˆ—è¡¨
        function renderMemberList() {
            const container = document.getElementById('memberList');
            const searchTerm = document.getElementById('searchMember')?.value.toLowerCase() || '';
            
            let filteredMembers = teamMembers;
            if (searchTerm) {
                filteredMembers = teamMembers.filter(member => 
                    member.name.toLowerCase().includes(searchTerm) ||
                    member.code.includes(searchTerm) ||
                    member.process.toLowerCase().includes(searchTerm)
                );
            }
            
            document.getElementById('memberCount').textContent = teamMembers.length;
            
            if (filteredMembers.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— æˆå‘˜æ•°æ®</div>';
                return;
            }
            
            let html = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>å§“å</th>
                            <th>å·¥å·</th>
                            <th>å·¥åº</th>
                            <th>è§’è‰²</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredMembers.forEach((member, index) => {
                const roleBadge = member.role === 'è´Ÿè´£äºº' ? 
                    '<span class="attendance-badge" style="background: #d4edda; color: #155724;">è´Ÿè´£äºº</span>' : 
                    '<span class="attendance-badge" style="background: #e8daef; color: #4a235a;">ç»„å‘˜</span>';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${member.name}
                                ${roleBadge}
                            </div>
                        </td>
                        <td>${member.code}</td>
                        <td>${member.process}</td>
                        <td>${member.role}</td>
                        <td>
                            <button onclick="editMember(${member.id})" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 5px;">
                                ç¼–è¾‘
                            </button>
                            <button onclick="deleteMember(${member.id})" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // æœç´¢æˆå‘˜
        document.getElementById('searchMember')?.addEventListener('input', renderMemberList);
        
        // ç¼–è¾‘æˆå‘˜
        function editMember(id) {
            const member = teamMembers.find(m => m.id === id);
            if (!member) return;
            
            // åˆ›å»ºéšè—çš„IDå­—æ®µ
            if (!document.getElementById('memberId')) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.id = 'memberId';
                input.name = 'memberId';
                document.getElementById('memberForm').prepend(input);
            }
            
            document.getElementById('memberId').value = member.id;
            document.getElementById('memberName').value = member.name;
            document.getElementById('memberCode').value = member.code;
            document.getElementById('memberProcess').value = member.process;
            document.getElementById('memberRole').value = member.role;
            
            document.getElementById('memberForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // åˆ é™¤æˆå‘˜
        function deleteMember(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™åæˆå‘˜å—ï¼Ÿç›¸å…³çš„è€ƒå‹¤è®°å½•å’Œæ’ç­è®¾ç½®ä¹Ÿå°†è¢«åˆ é™¤ã€‚')) return;
            
            try {
                const member = teamMembers.find(m => m.id === id);
                if (!member) return;
                
                // åˆ é™¤æˆå‘˜
                teamMembers = teamMembers.filter(m => m.id !== id);
                
                // åˆ é™¤ç›¸å…³è€ƒå‹¤è®°å½•
                attendanceRecords = attendanceRecords.filter(r => r.memberId !== id);
                
                // åˆ é™¤æ’ç­è®¾ç½®
                delete memberSchedules[id];
                
                saveAllData();
                renderMemberList();
                loadMemberOptions();
                
                showSuccessMessage('æˆå‘˜åˆ é™¤æˆåŠŸï¼');
            } catch (error) {
                console.error('åˆ é™¤æˆå‘˜æ—¶å‡ºé”™:', error);
                alert('åˆ é™¤æˆå‘˜æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // é‡ç½®æˆå‘˜è¡¨å•
        function resetMemberForm() {
            document.getElementById('memberForm').reset();
            const memberId = document.getElementById('memberId');
            if (memberId) memberId.value = '';
        }
        
        // ==================== æ’ç­è®¾ç½®æ¨¡å— ====================
        // åŠ è½½æˆå‘˜é€‰é¡¹
        function loadMemberOptions(selectId = 'scheduleMemberSelect') {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æˆå‘˜</option>';
            
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.code} - ${member.process})`;
                select.appendChild(option);
            });
            
            // åŠ è½½è€ƒå‹¤è®°å½•æ¨¡å—çš„æˆå‘˜é€‰é¡¹
            if (selectId === 'scheduleMemberSelect') {
                const attendanceSelect = document.getElementById('attendanceMember');
                if (attendanceSelect) {
                    attendanceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æˆå‘˜</option>';
                    teamMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.name} (${member.code} - ${member.process})`;
                        attendanceSelect.appendChild(option);
                    });
                }
                
                const editSelect = document.getElementById('editMember');
                if (editSelect) {
                    editSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æˆå‘˜</option>';
                    teamMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.name} (${member.code} - ${member.process})`;
                        editSelect.appendChild(option);
                    });
                }
            }
            
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // æˆå‘˜æ’ç­è®¾ç½®
        let currentRestDays = [];
        let currentMemberId = null;
        
        // åŠ è½½æˆå‘˜ä¼‘æ¯æ—¥è®¾ç½®
        function loadMemberRestDays() {
            const memberId = document.getElementById('scheduleMemberSelect').value;
            if (!memberId) return;
            
            currentMemberId = parseInt(memberId);
            const schedule = memberSchedules[memberId];
            
            if (schedule) {
                currentRestDays = [...(schedule.restDays || [])];
            } else {
                currentRestDays = [];
            }
            
            // æ›´æ–°ä¼‘æ¯æ—¥æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.day-selector').forEach(btn => {
                const day = parseInt(btn.getAttribute('data-day'));
                btn.classList.toggle('selected', currentRestDays.includes(day));
            });
        }
        
        // åˆ‡æ¢ä¼‘æ¯æ—¥
        function toggleRestDay(day) {
            const index = currentRestDays.indexOf(day);
            if (index === -1) {
                currentRestDays.push(day);
            } else {
                currentRestDays.splice(index, 1);
            }
            
            const btn = document.querySelector(`.day-selector[data-day="${day}"]`);
            btn.classList.toggle('selected');
        }
        
        // ä¿å­˜æˆå‘˜æ’ç­è®¾ç½®
        function saveMemberSchedule() {
            try {
                if (!currentMemberId) {
                    alert('è¯·å…ˆé€‰æ‹©æˆå‘˜ï¼');
                    return;
                }
                
                if (!memberSchedules[currentMemberId]) {
                    memberSchedules[currentMemberId] = {
                        restDays: [],
                        notes: ''
                    };
                }
                
                memberSchedules[currentMemberId].restDays = [...currentRestDays];
                
                saveAllData();
                
                // åŒæ­¥æ›´æ–°æ’ç­æ—¥å†å’Œè¯¦ç»†æ’ç­è¡¨
                renderCalendar();
                renderDetailedScheduleTable();
                
                const member = teamMembers.find(m => m.id === currentMemberId);
                showSuccessMessage(`${member.name} çš„æ’ç­è®¾ç½®å·²ä¿å­˜ï¼`);
            } catch (error) {
                console.error('ä¿å­˜æ’ç­è®¾ç½®æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜æ’ç­è®¾ç½®æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const container = document.getElementById('calendarBody');
            if (!container) return;
            
            const now = DateTime.now();
            const startOfMonth = now.startOf('month');
            const endOfMonth = now.endOf('month');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // å¡«å……ç©ºç™½ï¼ˆå¦‚æœæœˆåˆä¸æ˜¯å‘¨æ—¥ï¼‰
            const startWeekday = startOfMonth.weekday % 7; // 0=å‘¨æ—¥
            for (let i = 0; i < startWeekday; i++) {
                container.innerHTML += '<div style="min-height: 100px; background: #f8f9fa; border-radius: 8px;"></div>';
            }
            
            // å¡«å……æ—¥æœŸ
            let currentDate = startOfMonth;
            while (currentDate <= endOfMonth) {
                const dateStr = currentDate.toISODate();
                const weekday = currentDate.weekday % 7;
                const dayNumber = currentDate.day;
                
                // ç»Ÿè®¡è¿™ä¸€å¤©ä¼‘æ¯çš„äººæ•°
                const restMembers = getRestMembersForDate(dateStr);
                const restCount = restMembers.length;
                
                const isToday = currentDate.hasSame(now, 'day');
                const isWeekend = weekday === 0 || weekday === 6;
                const hasRest = restCount > 0;
                
                const dayElement = document.createElement('div');
                dayElement.className = `calendar-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''} ${hasRest ? 'rest-day' : ''}`;
                dayElement.innerHTML = `
                    <div class="day-number">${dayNumber}</div>
                    ${restCount > 0 ? `
                        <div class="rest-count">${restCount}äººä¼‘æ¯</div>
                    ` : ''}
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                dayElement.addEventListener('click', function() {
                    showRestDayModal(dateStr, restMembers);
                });
                
                container.appendChild(dayElement);
                currentDate = currentDate.plus({ days: 1 });
            }
        }
        
        // è·å–æŒ‡å®šæ—¥æœŸä¼‘æ¯çš„æˆå‘˜
        function getRestMembersForDate(dateStr) {
            const date = DateTime.fromISO(dateStr);
            const weekday = date.weekday % 7;
            
            return teamMembers.filter(member => {
                const schedule = memberSchedules[member.id];
                if (!schedule || !schedule.restDays) return false;
                return schedule.restDays.includes(weekday);
            });
        }
        
        // æ˜¾ç¤ºä¼‘æ¯æ—¥è¯¦æƒ…å¼¹çª—
        function showRestDayModal(dateStr, restMembers) {
            const date = DateTime.fromISO(dateStr);
            const modal = document.getElementById('restDayModal');
            const title = document.getElementById('modalTitle');
            const list = document.getElementById('restDayList');
            
            title.textContent = `${date.toLocaleString(DateTime.DATE_FULL)} ä¼‘æ¯äººå‘˜`;
            
            if (restMembers.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">å½“å¤©æ— äººä¼‘æ¯</p>';
            } else {
                let html = '<div style="max-height: 300px; overflow-y: auto;">';
                restMembers.forEach(member => {
                    const roleBadge = member.role === 'è´Ÿè´£äºº' ? 
                        '<span class="attendance-badge" style="background: #d4edda; color: #155724; margin-left: 10px;">è´Ÿè´£äºº</span>' : '';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${member.name}</strong>
                                ${roleBadge}
                                <div style="font-size: 14px; color: #666;">${member.process} | ${member.code}</div>
                            </div>
                            <button onclick="editMemberSchedule(${member.id})" style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ç¼–è¾‘æ’ç­
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
                list.innerHTML = html;
            }
            
            modal.style.display = 'flex';
        }
        
        // å…³é—­ä¼‘æ¯æ—¥è¯¦æƒ…å¼¹çª—
        function closeRestDayModal() {
            document.getElementById('restDayModal').style.display = 'none';
        }
        
        // ç¼–è¾‘æˆå‘˜æ’ç­
        function editMemberSchedule(memberId) {
            const member = teamMembers.find(m => m.id === memberId);
            if (!member) return;
            
            document.getElementById('scheduleMemberSelect').value = memberId;
            loadMemberRestDays();
            closeRestDayModal();
            
            // æ»šåŠ¨åˆ°æ’ç­è®¾ç½®åŒºåŸŸ
            document.getElementById('scheduleMemberSelect').scrollIntoView({ behavior: 'smooth' });
        }
        
        // æ¸²æŸ“è¯¦ç»†æ’ç­è¡¨
        function renderDetailedScheduleTable() {
            const container = document.getElementById('detailedScheduleTable');
            if (!container) return;
            
            if (teamMembers.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— æˆå‘˜æ•°æ®</div>';
                return;
            }
            
            let html = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>å·¥å·</th>
                            <th>å·¥åº</th>
                            <th>å‘¨æ—¥</th>
                            <th>å‘¨ä¸€</th>
                            <th>å‘¨äºŒ</th>
                            <th>å‘¨ä¸‰</th>
                            <th>å‘¨å››</th>
                            <th>å‘¨äº”</th>
                            <th>å‘¨å…­</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            teamMembers.forEach(member => {
                const schedule = memberSchedules[member.id];
                const restDays = schedule?.restDays || [];
                
                const roleBadge = member.role === 'è´Ÿè´£äºº' ? 
                    '<span class="attendance-badge" style="background: #d4edda; color: #155724; margin-left: 5px;">è´Ÿè´£äºº</span>' : '';
                
                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                ${member.name}
                                ${roleBadge}
                            </div>
                        </td>
                        <td>${member.code}</td>
                        <td>${member.process}</td>
                `;
                
                // æ·»åŠ ä¼‘æ¯æ—¥å•å…ƒæ ¼
                for (let day = 0; day < 7; day++) {
                    const isRestDay = restDays.includes(day);
                    html += `
                        <td style="text-align: center;">
                            ${isRestDay ? '<span style="color: #e74c3c; font-weight: bold;">âœ“</span>' : ''}
                        </td>
                    `;
                }
                
                html += `
                        <td>
                            <button onclick="editMemberSchedule(${member.id})" style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ç¼–è¾‘
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // ==================== è€ƒå‹¤è®°å½•æ¨¡å— ====================
        // è€ƒå‹¤ç±»å‹åˆ‡æ¢
        function initAttendanceTypeToggle() {
            document.querySelectorAll('input[name="attendanceType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const type = this.value;
                    const leaveDetails = document.getElementById('leaveDetails');
                    const earlyDetails = document.getElementById('earlyDetails');
                    
                    leaveDetails.style.display = ['sick_leave', 'personal_leave', 'annual_leave'].includes(type) ? 'block' : 'none';
                    earlyDetails.style.display = type === 'leave_early' ? 'block' : 'none';
                    
                    if (type === 'leave_early') {
                        calculateEarlyLeave();
                    }
                });
            });
            
            document.querySelectorAll('input[name="editAttendanceType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const type = this.value;
                    const leaveDetails = document.getElementById('editLeaveDetails');
                    const earlyDetails = document.getElementById('editEarlyDetails');
                    
                    leaveDetails.style.display = ['sick_leave', 'personal_leave', 'annual_leave'].includes(type) ? 'block' : 'none';
                    earlyDetails.style.display = type === 'leave_early' ? 'block' : 'none';
                    
                    if (type === 'leave_early') {
                        calculateEditEarlyLeave();
                    }
                });
            });
        }
        
        // è®¡ç®—æ—©é€€æ—¶é•¿
        function calculateEarlyLeave() {
            const actualOffTime = document.getElementById('actualOffTime').value;
            const standardOffTime = SHIFT_CONFIG.earlyThreshold;
            
            if (!actualOffTime) return;
            
            const actual = DateTime.fromFormat(actualOffTime, 'HH:mm');
            const standard = DateTime.fromFormat(standardOffTime, 'HH:mm');
            
            if (actual < standard) {
                const diff = standard.diff(actual, 'hours').hours;
                document.getElementById('earlyResult').style.display = 'block';
                document.getElementById('earlyHours').textContent = diff.toFixed(1);
            } else {
                document.getElementById('earlyResult').style.display = 'none';
            }
        }
        
        // è®¡ç®—ç¼–è¾‘æ—©é€€æ—¶é•¿
        function calculateEditEarlyLeave() {
            const actualOffTime = document.getElementById('editActualOffTime').value;
            const standardOffTime = SHIFT_CONFIG.earlyThreshold;
            
            if (!actualOffTime) return;
            
            const actual = DateTime.fromFormat(actualOffTime, 'HH:mm');
            const standard = DateTime.fromFormat(standardOffTime, 'HH:mm');
            
            if (actual < standard) {
                const diff = standard.diff(actual, 'hours').hours;
                document.getElementById('editEarlyResult').style.display = 'block';
                document.getElementById('editEarlyHours').textContent = diff.toFixed(1);
            } else {
                document.getElementById('editEarlyResult').style.display = 'none';
            }
        }
        
        // ä¿å­˜è€ƒå‹¤è®°å½•
        document.getElementById('attendanceForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const memberId = parseInt(document.getElementById('attendanceMember').value);
                const type = document.querySelector('input[name="attendanceType"]:checked').value;
                const date = document.getElementById('attendanceDate').value;
                
                if (!memberId || !date) {
                    alert('è¯·é€‰æ‹©æˆå‘˜å’Œæ—¥æœŸï¼');
                    return;
                }
                
                const member = teamMembers.find(m => m.id === memberId);
                if (!member) {
                    alert('æˆå‘˜ä¸å­˜åœ¨ï¼');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰å½“å¤©çš„è®°å½•
                const existingIndex = attendanceRecords.findIndex(r => 
                    r.memberId === memberId && r.date === date
                );
                
                let duration, leaveReason, actualOffTime, earlyLeaveDuration;
                
                if (['sick_leave', 'personal_leave', 'annual_leave'].includes(type)) {
                    duration = parseFloat(document.getElementById('leaveDuration').value) || 8;
                    leaveReason = document.getElementById('leaveReason').value;
                }
                
                if (type === 'leave_early') {
                    actualOffTime = document.getElementById('actualOffTime').value;
                    earlyLeaveDuration = parseFloat(document.getElementById('earlyHours')?.textContent) || 0;
                }
                
                // ç”Ÿæˆæ–°çš„è®°å½•ID
                let newId = 1;
                if (attendanceRecords.length > 0) {
                    newId = Math.max(...attendanceRecords.map(r => r.id)) + 1;
                }
                
                const record = {
                    id: existingIndex >= 0 ? attendanceRecords[existingIndex].id : newId,
                    memberId,
                    type,
                    date,
                    duration,
                    leaveReason,
                    actualOffTime,
                    earlyLeaveDuration,
                    recordedAt: DateTime.now().toISO()
                };
                
                if (existingIndex >= 0) {
                    attendanceRecords[existingIndex] = record;
                } else {
                    attendanceRecords.push(record);
                }
                
                // ä¿å­˜æ•°æ®åˆ°localStorage
                saveAllData();
                
                // æ›´æ–°ç•Œé¢
                loadTodayAttendance();
                resetAttendanceForm();
                
                // æ›´æ–°ç»Ÿè®¡å›¾è¡¨
                if (document.getElementById('statistics').classList.contains('active')) {
                    updateAllStatisticsCharts();
                }
                
                showSuccessMessage('è€ƒå‹¤è®°å½•ä¿å­˜æˆåŠŸï¼');
                
                // å¦‚æœå½“å‰åœ¨å†å²æ¨¡å—ï¼Œé‡æ–°åŠ è½½å†å²æ•°æ®
                if (document.getElementById('history').classList.contains('active')) {
                    loadHistoryData(currentHistoryPage);
                }
            } catch (error) {
                console.error('ä¿å­˜è€ƒå‹¤è®°å½•æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜è€ƒå‹¤è®°å½•æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        });
        
        // åŠ è½½ä»Šæ—¥è€ƒå‹¤ï¼ˆåªæ˜¾ç¤ºæœ‰è®°å½•çš„ï¼Œæ­£å¸¸å‡ºå‹¤ä¸æ˜¾ç¤ºï¼‰
        function loadTodayAttendance() {
            const today = DateTime.now().toISODate();
            const todayRecords = attendanceRecords.filter(r => r.date === today);
            
            document.getElementById('todayRecordCount').textContent = todayRecords.length;
            
            const container = document.getElementById('todayAttendanceList');
            if (!container) return;
            
            if (todayRecords.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">ä»Šæ—¥æš‚æ— è€ƒå‹¤è®°å½•ï¼ˆæ­£å¸¸å‡ºå‹¤ä¸æ˜¾ç¤ºï¼‰</div>';
                return;
            }
            
            let html = '<table class="schedule-table"><thead><tr><th>å§“å</th><th>å·¥åº</th><th>è€ƒå‹¤ç±»å‹</th><th>æ—¶é—´</th></tr></thead><tbody>';
            
            todayRecords.forEach(record => {
                const member = teamMembers.find(m => m.id === record.memberId);
                if (!member) return;
                
                const typeBadge = getAttendanceTypeBadge(record.type);
                const time = record.recordedAt ? 
                    DateTime.fromISO(record.recordedAt).toFormat('HH:mm') : '-';
                
                html += `
                    <tr>
                        <td>${member.name}</td>
                        <td>${member.process}</td>
                        <td>${typeBadge}</td>
                        <td>${time}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // è·å–è€ƒå‹¤ç±»å‹æ ‡ç­¾
        function getAttendanceTypeBadge(type) {
            const badgeMap = {
                'late': { text: 'è¿Ÿåˆ°', class: 'badge-late' },
                'leave_early': { text: 'æ—©é€€', class: 'badge-early' },
                'sick_leave': { text: 'ç—…å‡', class: 'badge-sick' },
                'personal_leave': { text: 'äº‹å‡', class: 'badge-personal' },
                'annual_leave': { text: 'å¹´å‡', class: 'badge-annual' },
                'absent': { text: 'ç¼ºå‹¤', class: 'badge-absent' },
                'o_rest': { text: 'Oç­ä¼‘æ¯', class: 'badge-o-rest' },
                'b_rest': { text: 'Bç­ä¼‘æ¯', class: 'badge-b-rest' }
            };
            
            const badge = badgeMap[type] || { text: 'æœªçŸ¥', class: '' };
            return `<span class="attendance-badge ${badge.class}">${badge.text}</span>`;
        }
        
        // é‡ç½®è€ƒå‹¤è¡¨å•
        function resetAttendanceForm() {
            document.getElementById('attendanceForm').reset();
            document.getElementById('leaveDetails').style.display = 'none';
            document.getElementById('earlyDetails').style.display = 'none';
            document.getElementById('earlyResult').style.display = 'none';
            document.getElementById('attendanceDate').value = DateTime.now().toISODate();
            document.getElementById('actualOffTime').value = '19:00';
        }
        
        // ==================== è€ƒå‹¤å†å²æ¨¡å— ====================
        // åˆå§‹åŒ–å†å²æ¨¡å—
        function initHistoryModule() {
            // åˆå§‹åŒ–å¹´ä»½é€‰é¡¹
            initYearOptions('historyYear');
            
            // åˆå§‹åŒ–å·¥åºé€‰é¡¹
            const historyProcessSelect = document.getElementById('historyProcess');
            historyProcessSelect.innerHTML = '<option value="">é€‰æ‹©å·¥åº</option>';
            processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process;
                option.textContent = process;
                historyProcessSelect.appendChild(option);
            });
            
            // åŠ è½½å†å²æ•°æ®
            loadHistoryData();
        }
        
        // åˆå§‹åŒ–å¹´ä»½é€‰é¡¹
        function initYearOptions(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentYear = DateTime.now().year;
            select.innerHTML = '<option value="">é€‰æ‹©å¹´ä»½</option>';
            
            // è·å–æ‰€æœ‰æœ‰è®°å½•çš„å¹´ä»½
            const years = new Set();
            attendanceRecords.forEach(record => {
                const year = DateTime.fromISO(record.date).year;
                years.add(year);
            });
            
            // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œæ·»åŠ å½“å‰å¹´ä»½
            if (years.size === 0) {
                years.add(currentYear);
            }
            
            // æŒ‰é™åºæ’åº
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}å¹´`;
                select.appendChild(option);
            });
            
            // é»˜è®¤é€‰æ‹©å½“å‰å¹´ä»½
            select.value = currentYear;
        }
        
        // åŠ è½½å†å²æ•°æ®
        function loadHistoryData(page = 1) {
            try {
                currentHistoryPage = page;
                
                // è·å–ç­›é€‰æ¡ä»¶
                const year = document.getElementById('historyYear').value;
                const month = document.getElementById('historyMonth').value;
                const process = document.getElementById('historyProcess').value;
                const type = document.getElementById('historyType').value;
                
                // ç­›é€‰æ•°æ®
                filteredHistoryRecords = attendanceRecords.filter(record => {
                    const recordDate = DateTime.fromISO(record.date);
                    const recordYear = recordDate.year.toString();
                    const recordMonth = recordDate.month.toString();
                    const member = teamMembers.find(m => m.id === record.memberId);
                    
                    // å¹´ä»½ç­›é€‰
                    if (year && recordYear !== year) return false;
                    
                    // æœˆä»½ç­›é€‰
                    if (month && recordMonth !== month) return false;
                    
                    // å·¥åºç­›é€‰
                    if (process && member && member.process !== process) return false;
                    
                    // ç±»å‹ç­›é€‰
                    if (type && record.type !== type) return false;
                    
                    return true;
                });
                
                // åˆ†é¡µ
                const startIndex = (page - 1) * historyPageSize;
                const endIndex = startIndex + historyPageSize;
                const pageRecords = filteredHistoryRecords.slice(startIndex, endIndex);
                const totalPages = Math.ceil(filteredHistoryRecords.length / historyPageSize);
                
                // æ›´æ–°ç­›é€‰æ‘˜è¦
                updateHistoryFilterSummary(year, month, process, type);
                
                // æ¸²æŸ“è¡¨æ ¼
                const tbody = document.getElementById('historyTableBody');
                
                if (filteredHistoryRecords.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 40px; color: #666;">
                                æš‚æ— åŒ¹é…çš„å†å²è®°å½•
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    pageRecords.forEach((record, index) => {
                        const member = teamMembers.find(m => m.id === record.memberId);
                        const typeBadge = getAttendanceTypeBadge(record.type);
                        const recordDate = DateTime.fromISO(record.date);
                        const recordTime = DateTime.fromISO(record.recordedAt);
                        
                        html += `
                            <tr>
                                <td>${startIndex + index + 1}</td>
                                <td>${recordDate.toFormat('yyyy-MM-dd')}</td>
                                <td>${member ? member.name : 'æœªçŸ¥'}</td>
                                <td>${member ? member.code : ''}</td>
                                <td>${member ? member.process : ''}</td>
                                <td>${typeBadge}</td>
                                <td>${record.duration || '-'}</td>
                                <td>${record.leaveReason || record.actualOffTime || '-'}</td>
                                <td>${recordTime.toFormat('MM-dd HH:mm')}</td>
                                <td>
                                    <button onclick="editHistoryRecord(${record.id})" style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                        ç¼–è¾‘
                                    </button>
                                    <button onclick="deleteHistoryRecord(${record.id})" style="padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        åˆ é™¤
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                }
                
                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                document.getElementById('historyPageInfo').textContent = 
                    `ç¬¬ ${page} é¡µ / å…± ${totalPages} é¡µ (å…± ${filteredHistoryRecords.length} æ¡è®°å½•)`;
                
                // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
                updatePaginationButtons(totalPages);
                
                // æ›´æ–°æ•°æ®çŠ¶æ€
                updateDataStatus();
            } catch (error) {
                console.error('åŠ è½½å†å²æ•°æ®æ—¶å‡ºé”™:', error);
                alert('åŠ è½½å†å²æ•°æ®æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // æ›´æ–°å†å²ç­›é€‰æ‘˜è¦
        function updateHistoryFilterSummary(year, month, process, type) {
            let summary = 'å…¨éƒ¨è®°å½•';
            
            if (year || month || process || type) {
                summary = '';
                if (year) summary += `${year}å¹´`;
                if (month) summary += `${month}æœˆ`;
                if (process) summary += ` ${process}`;
                if (type) {
                    const typeMap = {
                        'late': 'è¿Ÿåˆ°',
                        'leave_early': 'æ—©é€€',
                        'sick_leave': 'ç—…å‡',
                        'personal_leave': 'äº‹å‡',
                        'annual_leave': 'å¹´å‡',
                        'absent': 'ç¼ºå‹¤',
                        'o_rest': 'Oç­ä¼‘æ¯',
                        'b_rest': 'Bç­ä¼‘æ¯'
                    };
                    summary += ` ${typeMap[type] || type}`;
                }
            }
            
            document.getElementById('historyFilterSummary').textContent = summary;
        }
        
        // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
        function updatePaginationButtons(totalPages) {
            const prevBtn = document.querySelector('button[onclick="prevHistoryPage()"]');
            const nextBtn = document.querySelector('button[onclick="nextHistoryPage()"]');
            
            if (prevBtn) {
                prevBtn.disabled = currentHistoryPage <= 1;
                prevBtn.style.opacity = currentHistoryPage <= 1 ? '0.5' : '1';
            }
            if (nextBtn) {
                nextBtn.disabled = currentHistoryPage >= totalPages;
                nextBtn.style.opacity = currentHistoryPage >= totalPages ? '0.5' : '1';
            }
        }
        
        // ä¸Šä¸€é¡µ
        function prevHistoryPage() {
            if (currentHistoryPage > 1) {
                loadHistoryData(currentHistoryPage - 1);
            }
        }
        
        // ä¸‹ä¸€é¡µ
        function nextHistoryPage() {
            const totalPages = Math.ceil(filteredHistoryRecords.length / historyPageSize);
            if (currentHistoryPage < totalPages) {
                loadHistoryData(currentHistoryPage + 1);
            }
        }
        
        // æ¸…é™¤ç­›é€‰æ¡ä»¶
        function clearHistoryFilters() {
            document.getElementById('historyYear').value = '';
            document.getElementById('historyMonth').value = '';
            document.getElementById('historyProcess').value = '';
            document.getElementById('historyType').value = '';
            loadHistoryData(1);
        }
        
        // ç¼–è¾‘å†å²è®°å½•
        function editHistoryRecord(recordId) {
            try {
                const record = attendanceRecords.find(r => r.id === recordId);
                if (!record) return;
                
                const member = teamMembers.find(m => m.id === record.memberId);
                if (!member) return;
                
                // å¡«å……è¡¨å•
                document.getElementById('editRecordId').value = record.id;
                loadMemberOptions('editMember');
                document.getElementById('editMember').value = record.memberId;
                document.getElementById('editDate').value = record.date;
                
                // è®¾ç½®è€ƒå‹¤ç±»å‹
                const typeRadio = document.querySelector(`input[name="editAttendanceType"][value="${record.type}"]`);
                if (typeRadio) {
                    typeRadio.checked = true;
                }
                
                // è®¾ç½®è¯·å‡è¯¦æƒ…
                if (['sick_leave', 'personal_leave', 'annual_leave'].includes(record.type)) {
                    document.getElementById('editLeaveDetails').style.display = 'block';
                    document.getElementById('editLeaveDuration').value = record.duration || 8;
                    document.getElementById('editLeaveReason').value = record.leaveReason || '';
                } else {
                    document.getElementById('editLeaveDetails').style.display = 'none';
                }
                
                // è®¾ç½®æ—©é€€è¯¦æƒ…
                if (record.type === 'leave_early') {
                    document.getElementById('editEarlyDetails').style.display = 'block';
                    document.getElementById('editActualOffTime').value = record.actualOffTime || '19:00';
                    calculateEditEarlyLeave();
                } else {
                    document.getElementById('editEarlyDetails').style.display = 'none';
                }
                
                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('editHistoryModal').style.display = 'flex';
            } catch (error) {
                console.error('ç¼–è¾‘å†å²è®°å½•æ—¶å‡ºé”™:', error);
                alert('ç¼–è¾‘å†å²è®°å½•æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // ä¿å­˜ç¼–è¾‘çš„å†å²è®°å½•
        document.getElementById('editHistoryForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const recordId = parseInt(document.getElementById('editRecordId').value);
                const memberId = parseInt(document.getElementById('editMember').value);
                const type = document.querySelector('input[name="editAttendanceType"]:checked').value;
                const date = document.getElementById('editDate').value;
                
                const recordIndex = attendanceRecords.findIndex(r => r.id === recordId);
                if (recordIndex === -1) return;
                
                let duration, leaveReason, actualOffTime, earlyLeaveDuration;
                
                if (['sick_leave', 'personal_leave', 'annual_leave'].includes(type)) {
                    duration = parseFloat(document.getElementById('editLeaveDuration').value) || 8;
                    leaveReason = document.getElementById('editLeaveReason').value;
                }
                
                if (type === 'leave_early') {
                    actualOffTime = document.getElementById('editActualOffTime').value;
                    earlyLeaveDuration = parseFloat(document.getElementById('editEarlyHours')?.textContent) || 0;
                }
                
                attendanceRecords[recordIndex] = {
                    ...attendanceRecords[recordIndex],
                    memberId,
                    type,
                    date,
                    duration,
                    leaveReason,
                    actualOffTime,
                    earlyLeaveDuration,
                    recordedAt: DateTime.now().toISO()
                };
                
                saveAllData();
                loadHistoryData(currentHistoryPage);
                closeEditModal();
                
                // æ›´æ–°ç»Ÿè®¡å›¾è¡¨
                if (document.getElementById('statistics').classList.contains('active')) {
                    updateAllStatisticsCharts();
                }
                
                showSuccessMessage('è€ƒå‹¤è®°å½•ä¿®æ”¹æˆåŠŸï¼');
            } catch (error) {
                console.error('ä¿å­˜ç¼–è¾‘æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜ç¼–è¾‘æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        });
        
        // å…³é—­ç¼–è¾‘å¼¹çª—
        function closeEditModal() {
            document.getElementById('editHistoryModal').style.display = 'none';
        }
        
        // åˆ é™¤å†å²è®°å½•
        function deleteHistoryRecord(recordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è€ƒå‹¤è®°å½•å—ï¼Ÿ')) return;
            
            try {
                attendanceRecords = attendanceRecords.filter(r => r.id !== recordId);
                saveAllData();
                loadHistoryData(currentHistoryPage);
                
                // æ›´æ–°ç»Ÿè®¡å›¾è¡¨
                if (document.getElementById('statistics').classList.contains('active')) {
                    updateAllStatisticsCharts();
                }
                
                showSuccessMessage('è€ƒå‹¤è®°å½•åˆ é™¤æˆåŠŸï¼');
            } catch (error) {
                console.error('åˆ é™¤è®°å½•æ—¶å‡ºé”™:', error);
                alert('åˆ é™¤è®°å½•æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // åˆ é™¤æ‰€æœ‰å†å²è®°å½•
        function deleteAllHistoryData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è€ƒå‹¤è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
            
            try {
                attendanceRecords = [];
                saveAllData();
                loadHistoryData(1);
                
                // æ›´æ–°ç»Ÿè®¡å›¾è¡¨
                if (document.getElementById('statistics').classList.contains('active')) {
                    updateAllStatisticsCharts();
                }
                
                showSuccessMessage('æ‰€æœ‰è€ƒå‹¤è®°å½•å·²æ¸…ç©ºï¼');
            } catch (error) {
                console.error('æ¸…ç©ºè®°å½•æ—¶å‡ºé”™:', error);
                alert('æ¸…ç©ºè®°å½•æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // å¯¼å‡ºå†å²æ•°æ®
        function exportHistoryData() {
            try {
                const dataStr = JSON.stringify(attendanceRecords, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `è€ƒå‹¤å†å²æ•°æ®_${DateTime.now().toFormat('yyyy-MM-dd')}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showSuccessMessage('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™:', error);
                alert('å¯¼å‡ºæ•°æ®æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // å¯¼å…¥å†å²æ•°æ®
        function importHistoryData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶ï¼');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        alert('å¯¼å…¥çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼');
                        return;
                    }
                    
                    // å¤‡ä»½å½“å‰æ•°æ®
                    historyBackup = [...attendanceRecords];
                    localStorage.setItem('history_backup', JSON.stringify(historyBackup));
                    
                    // åˆå¹¶æ•°æ®
                    importedData.forEach(record => {
                        const existingIndex = attendanceRecords.findIndex(r => 
                            r.id === record.id || 
                            (r.memberId === record.memberId && r.date === record.date)
                        );
                        
                        if (existingIndex >= 0) {
                            attendanceRecords[existingIndex] = record;
                        } else {
                            // ä¸ºæ–°è®°å½•åˆ†é…ID
                            record.id = attendanceRecords.length > 0 ? 
                                Math.max(...attendanceRecords.map(r => r.id)) + 1 : 1;
                            attendanceRecords.push(record);
                        }
                    });
                    
                    saveAllData();
                    loadHistoryData(1);
                    
                    // æ›´æ–°ç»Ÿè®¡å›¾è¡¨
                    if (document.getElementById('statistics').classList.contains('active')) {
                        updateAllStatisticsCharts();
                    }
                    
                    showSuccessMessage(`æˆåŠŸå¯¼å…¥ ${importedData.length} æ¡æ•°æ®ï¼`);
                    fileInput.value = '';
                } catch (error) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼');
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
        }
        
        // å¤‡ä»½å†å²æ•°æ®
        function backupHistoryData() {
            try {
                historyBackup = [...attendanceRecords];
                localStorage.setItem('history_backup', JSON.stringify(historyBackup));
                
                const dataStr = JSON.stringify(attendanceRecords, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `è€ƒå‹¤æ•°æ®å¤‡ä»½_${DateTime.now().toFormat('yyyy-MM-dd_HH-mm')}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showSuccessMessage('æ•°æ®å¤‡ä»½å®Œæˆï¼');
            } catch (error) {
                console.error('å¤‡ä»½æ•°æ®æ—¶å‡ºé”™:', error);
                alert('å¤‡ä»½æ•°æ®æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // æ¢å¤å¤‡ä»½æ•°æ®
        function restoreHistoryData() {
            if (historyBackup.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ•°æ®ï¼');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ¢å¤å¤‡ä»½æ•°æ®å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼')) return;
            
            try {
                attendanceRecords = [...historyBackup];
                saveAllData();
                loadHistoryData(1);
                
                // æ›´æ–°ç»Ÿè®¡å›¾è¡¨
                if (document.getElementById('statistics').classList.contains('active')) {
                    updateAllStatisticsCharts();
                }
                
                showSuccessMessage('æ•°æ®æ¢å¤æˆåŠŸï¼');
            } catch (error) {
                console.error('æ¢å¤æ•°æ®æ—¶å‡ºé”™:', error);
                alert('æ¢å¤æ•°æ®æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼');
            }
        }
        
        // ==================== æ•°æ®ç»Ÿè®¡æ¨¡å— ====================
        // åˆå§‹åŒ–ç»Ÿè®¡æ¨¡å—
        function initStatisticsModule() {
            // åˆå§‹åŒ–å¹´ä»½é€‰é¡¹
            initStatisticsYearOptions();
            
            // åˆå§‹åŒ–å·¥åºé€‰é¡¹
            initProcessOptions();
            
            // æ›´æ–°æ‰€æœ‰ç»Ÿè®¡å›¾è¡¨
            updateAllStatisticsCharts();
        }
        
        // åˆå§‹åŒ–ç»Ÿè®¡å¹´ä»½é€‰é¡¹
        function initStatisticsYearOptions() {
            const currentYear = DateTime.now().year;
            
            // åˆå§‹åŒ–æ‰€æœ‰å¹´ä»½é€‰æ‹©å™¨
            ['dateStatYear', 'processStatYear', 'memberStatYear', 'yearStatYear'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                // è·å–æ‰€æœ‰æœ‰è®°å½•çš„å¹´ä»½
                const years = new Set();
                attendanceRecords.forEach(record => {
                    const year = DateTime.fromISO(record.date).year;
                    years.add(year);
                });
                
                // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œæ·»åŠ å½“å‰å¹´ä»½
                if (years.size === 0) {
                    years.add(currentYear);
                }
                
                // æŒ‰é™åºæ’åº
                const sortedYears = Array.from(years).sort((a, b) => b - a);
                
                select.innerHTML = '<option value="">é€‰æ‹©å¹´ä»½</option>';
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `${year}å¹´`;
                    select.appendChild(option);
                });
                
                // é»˜è®¤é€‰æ‹©å½“å‰å¹´ä»½
                select.value = currentYear;
            });
            
            // è®¾ç½®é»˜è®¤æœˆä»½ä¸ºå½“å‰æœˆä»½
            const currentMonth = DateTime.now().month;
            ['dateStatMonth', 'processStatMonth', 'memberStatMonth'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.value = currentMonth;
                }
            });
        }
        
        // åˆå§‹åŒ–å·¥åºé€‰é¡¹
        function initProcessOptions() {
            // æ—¥æœŸçº¬åº¦å·¥åºé€‰é¡¹
            const dateProcessSelect = document.getElementById('dateStatProcess');
            if (dateProcessSelect) {
                dateProcessSelect.innerHTML = '<option value="all">å…¨éƒ¨å·¥åº</option>';
                processes.forEach(process => {
                    const option = document.createElement('option');
                    option.value = process;
                    option.textContent = process;
                    dateProcessSelect.appendChild(option);
                });
            }
            
            // æˆå‘˜çº¬åº¦å·¥åºé€‰é¡¹
            const memberProcessSelect = document.getElementById('memberStatProcess');
            if (memberProcessSelect) {
                memberProcessSelect.innerHTML = '<option value="all">å…¨éƒ¨å·¥åº</option>';
                processes.forEach(process => {
                    const option = document.createElement('option');
                    option.value = process;
                    option.textContent = process;
                    memberProcessSelect.appendChild(option);
                });
            }
        }
        
        // æ›´æ–°æ‰€æœ‰ç»Ÿè®¡å›¾è¡¨
        function updateAllStatisticsCharts() {
            updateDateDimensionChart();
            updateProcessDimensionChart();
            updateMemberDimensionTable();
            updateYearDimensionChart();
        }
        
        // ç¬¬ä¸€çº¬åº¦ï¼šæ—¥æœŸçº¬åº¦ - æ¯æ—¥å‡ºå‹¤äººæ•°å˜åŒ–
        function updateDateDimensionChart() {
            const year = document.getElementById('dateStatYear').value;
            const month = document.getElementById('dateStatMonth').value;
            const process = document.getElementById('dateStatProcess').value;
            
            if (!year || !month) return;
            
            const ctx = document.getElementById('dateDimensionChart')?.getContext('2d');
            if (!ctx) return;
            
            try {
                const startDate = DateTime.fromObject({ year: parseInt(year), month: parseInt(month), day: 1 });
                const daysInMonth = startDate.daysInMonth;
                
                // å‡†å¤‡æ•°æ®
                const labels = [];
                const attendanceData = [];
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = DateTime.fromObject({ year: parseInt(year), month: parseInt(month), day: day });
                    labels.push(day);
                    
                    // è®¡ç®—å½“å¤©çš„å‡ºå‹¤äººæ•°
                    const dateStr = currentDate.toISODate();
                    const attendanceCount = calculateAttendanceForDate(dateStr, process === 'all' ? 'all' : process);
                    attendanceData.push(attendanceCount);
                }
                
                // é”€æ¯æ—§å›¾è¡¨
                if (dateDimensionChart) {
                    dateDimensionChart.destroy();
                }
                
                dateDimensionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å‡ºå‹¤äººæ•°',
                            data: attendanceData,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'å‡ºå‹¤äººæ•°'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `${year}å¹´${month}æœˆæ¯æ—¥å‡ºå‹¤äººæ•°å˜åŒ–ï¼ˆ${process === 'all' ? 'å…¨éƒ¨å·¥åº' : process}ï¼‰`
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('æ›´æ–°æ—¥æœŸçº¬åº¦å›¾è¡¨æ—¶å‡ºé”™:', error);
            }
        }
        
        // ç¬¬äºŒçº¬åº¦ï¼šå·¥åºçº¬åº¦ - å½“æœˆå„å·¥åºå‡ºå‹¤æ•°æ®å¯¹æ¯”
        function updateProcessDimensionChart() {
            const year = document.getElementById('processStatYear').value;
            const month = document.getElementById('processStatMonth').value;
            
            if (!year || !month) return;
            
            const ctx = document.getElementById('processDimensionChart')?.getContext('2d');
            if (!ctx) return;
            
            try {
                const startDate = DateTime.fromObject({ year: parseInt(year), month: parseInt(month), day: 1 });
                const endDate = startDate.endOf('month');
                const daysInMonth = startDate.daysInMonth;
                
                // å‡†å¤‡æ•°æ®
                const labels = processes;
                const datasets = [
                    {
                        label: 'å‡ºå‹¤ç‡(%)',
                        data: [],
                        backgroundColor: '#3498db',
                        borderWidth: 1
                    },
                    {
                        label: 'è¿Ÿåˆ°æ¬¡æ•°',
                        data: [],
                        backgroundColor: '#f39c12',
                        borderWidth: 1
                    },
                    {
                        label: 'æ—©é€€æ¬¡æ•°',
                        data: [],
                        backgroundColor: '#e74c3c',
                        borderWidth: 1
                    },
                    {
                        label: 'è¯·å‡æ¬¡æ•°',
                        data: [],
                        backgroundColor: '#9b59b6',
                        borderWidth: 1
                    },
                    {
                        label: 'ä¼‘æ¯æ¬¡æ•°',
                        data: [],
                        backgroundColor: '#1abc9c',
                        borderWidth: 1
                    },
                    {
                        label: 'ç¼ºå‹¤æ¬¡æ•°',
                        data: [],
                        backgroundColor: '#95a5a6',
                        borderWidth: 1
                    }
                ];
                
                // è®¡ç®—å„å·¥åºæ•°æ®
                processes.forEach(process => {
                    const processMembers = teamMembers.filter(m => m.process === process);
                    const memberIds = processMembers.map(m => m.id);
                    
                    // ç­›é€‰å½“æœˆè¯¥å·¥åºçš„è€ƒå‹¤è®°å½•
                    const monthRecords = attendanceRecords.filter(r => 
                        r.date >= startDate.toISODate() && 
                        r.date <= endDate.toISODate() &&
                        memberIds.includes(r.memberId)
                    );
                    
                    const totalMembers = processMembers.length;
                    
                    if (totalMembers === 0) {
                        datasets[0].data.push(0);
                        datasets[1].data.push(0);
                        datasets[2].data.push(0);
                        datasets[3].data.push(0);
                        datasets[4].data.push(0);
                        datasets[5].data.push(0);
                        return;
                    }
                    
                    // è®¡ç®—å·¥ä½œæ—¥æ€»æ•°
                    const totalWorkDays = totalMembers * daysInMonth;
                    
                    // è®¡ç®—æœªå‡ºå‹¤å¤©æ•°ï¼ˆæœ‰ç¼ºå‹¤ã€è¯·å‡ã€ä¼‘æ¯è®°å½•çš„å¤©æ•°ï¼‰
                    const absentDays = monthRecords.filter(r => 
                        isAbsentType(r.type)
                    ).length;
                    
                    // è®¡ç®—å‡ºå‹¤å¤©æ•°
                    const attendanceDays = totalWorkDays - absentDays;
                    
                    // è®¡ç®—å‡ºå‹¤ç‡
                    const attendanceRate = totalWorkDays > 0 ? 
                        (attendanceDays / totalWorkDays * 100).toFixed(1) : 0;
                    
                    // è®¡ç®—å„ç±»è€ƒå‹¤æ¬¡æ•°
                    const lateCount = monthRecords.filter(r => r.type === 'late').length;
                    const earlyCount = monthRecords.filter(r => r.type === 'leave_early').length;
                    const leaveCount = monthRecords.filter(r => 
                        ['sick_leave', 'personal_leave', 'annual_leave'].includes(r.type)
                    ).length;
                    const restCount = monthRecords.filter(r => 
                        r.type === 'o_rest' || r.type === 'b_rest'
                    ).length;
                    const absentCount = monthRecords.filter(r => r.type === 'absent').length;
                    
                    datasets[0].data.push(attendanceRate);
                    datasets[1].data.push(lateCount);
                    datasets[2].data.push(earlyCount);
                    datasets[3].data.push(leaveCount);
                    datasets[4].data.push(restCount);
                    datasets[5].data.push(absentCount);
                });
                
                // é”€æ¯æ—§å›¾è¡¨
                if (processDimensionChart) {
                    processDimensionChart.destroy();
                }
                
                processDimensionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'æ¬¡æ•°/ç™¾åˆ†æ¯”'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `${year}å¹´${month}æœˆå„å·¥åºå‡ºå‹¤æ•°æ®å¯¹æ¯”`
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.datasetIndex === 0) {
                                            label += context.raw + '%';
                                        } else {
                                            label += context.raw + 'æ¬¡';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('æ›´æ–°å·¥åºçº¬åº¦å›¾è¡¨æ—¶å‡ºé”™:', error);
            }
        }
        
        // ç¬¬ä¸‰çº¬åº¦ï¼šæˆå‘˜çº¬åº¦ - å½“æœˆæˆå‘˜å‡ºå‹¤æƒ…å†µ
        function updateMemberDimensionTable() {
            const year = document.getElementById('memberStatYear').value;
            const month = document.getElementById('memberStatMonth').value;
            const process = document.getElementById('memberStatProcess').value;
            
            if (!year || !month) return;
            
            try {
                const startDate = DateTime.fromObject({ year: parseInt(year), month: parseInt(month), day: 1 });
                const endDate = startDate.endOf('month');
                const daysInMonth = startDate.daysInMonth;
                
                // ç­›é€‰ç›¸å…³æˆå‘˜
                let relevantMembers = teamMembers;
                if (process !== 'all') {
                    relevantMembers = teamMembers.filter(m => m.process === process);
                }
                
                // è·å–å½“æœˆè€ƒå‹¤è®°å½•
                const monthRecords = attendanceRecords.filter(r => 
                    r.date >= startDate.toISODate() && 
                    r.date <= endDate.toISODate()
                );
                
                const tbody = document.getElementById('memberDimensionBody');
                
                if (relevantMembers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                                æš‚æ— æˆå‘˜æ•°æ®
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                relevantMembers.forEach(member => {
                    // è·å–è¯¥æˆå‘˜çš„å½“æœˆè€ƒå‹¤è®°å½•
                    const memberRecords = monthRecords.filter(r => r.memberId === member.id);
                    
                    // è®¡ç®—å·¥ä½œæ—¥æ€»æ•°
                    const totalWorkDays = daysInMonth;
                    
                    // è®¡ç®—æœªå‡ºå‹¤å¤©æ•°ï¼ˆæœ‰ç¼ºå‹¤ã€è¯·å‡ã€ä¼‘æ¯è®°å½•çš„å¤©æ•°ï¼‰
                    const absentDays = memberRecords.filter(r => 
                        isAbsentType(r.type)
                    ).length;
                    
                    // è®¡ç®—å‡ºå‹¤å¤©æ•°
                    const attendanceDays = totalWorkDays - absentDays;
                    
                    // è®¡ç®—å„ç±»è€ƒå‹¤æ¬¡æ•°
                    const lateCount = memberRecords.filter(r => r.type === 'late').length;
                    const earlyCount = memberRecords.filter(r => r.type === 'leave_early').length;
                    const leaveCount = memberRecords.filter(r => 
                        ['sick_leave', 'personal_leave', 'annual_leave'].includes(r.type)
                    ).length;
                    const restCount = memberRecords.filter(r => 
                        r.type === 'o_rest' || r.type === 'b_rest'
                    ).length;
                    
                    // è®¡ç®—å‡ºå‹¤ç‡
                    const attendanceRate = totalWorkDays > 0 ? 
                        (attendanceDays / totalWorkDays * 100).toFixed(1) : 0;
                    
                    html += `
                        <tr>
                            <td>${member.name}</td>
                            <td>${member.code}</td>
                            <td>${member.process}</td>
                            <td>${attendanceDays}</td>
                            <td>${lateCount}</td>
                            <td>${earlyCount}</td>
                            <td>${leaveCount}</td>
                            <td>${restCount}</td>
                            <td>${attendanceRate}%</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
            } catch (error) {
                console.error('æ›´æ–°æˆå‘˜çº¬åº¦è¡¨æ ¼æ—¶å‡ºé”™:', error);
            }
        }
        
        // ç¬¬å››çº¬åº¦ï¼šå¹´åº¦çº¬åº¦ - æ¯æœˆå‡ºå‹¤æƒ…å†µå¯¹æ¯”
        function updateYearDimensionChart() {
            const year = document.getElementById('yearStatYear').value;
            const metric = document.getElementById('yearStatMetric').value;
            
            if (!year) return;
            
            const ctx = document.getElementById('yearDimensionChart')?.getContext('2d');
            if (!ctx) return;
            
            try {
                // å‡†å¤‡æ•°æ®
                const labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 
                              '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                const data = new Array(12).fill(0);
                
                // æ ¹æ®é€‰æ‹©çš„æŒ‡æ ‡è®¡ç®—æ•°æ®
                for (let month = 1; month <= 12; month++) {
                    const startDate = DateTime.fromObject({ year: parseInt(year), month: month, day: 1 });
                    const endDate = startDate.endOf('month');
                    
                    // ç­›é€‰å½“æœˆè€ƒå‹¤è®°å½•
                    const monthRecords = attendanceRecords.filter(r => 
                        r.date >= startDate.toISODate() && 
                        r.date <= endDate.toISODate()
                    );
                    
                    // è®¡ç®—å½“æœˆå¤©æ•°
                    const daysInMonth = startDate.daysInMonth;
                    const totalMembers = teamMembers.length;
                    const totalWorkDays = totalMembers * daysInMonth;
                    
                    switch(metric) {
                        case 'attendance_rate':
                            // è®¡ç®—æœªå‡ºå‹¤å¤©æ•°ï¼ˆæœ‰ç¼ºå‹¤ã€è¯·å‡ã€ä¼‘æ¯è®°å½•çš„å¤©æ•°ï¼‰
                            const absentDays = monthRecords.filter(r => 
                                isAbsentType(r.type)
                            ).length;
                            
                            // è®¡ç®—å‡ºå‹¤å¤©æ•°
                            const attendanceDays = totalWorkDays - absentDays;
                            
                            // è®¡ç®—å‡ºå‹¤ç‡
                            data[month-1] = totalWorkDays > 0 ? 
                                (attendanceDays / totalWorkDays * 100).toFixed(1) : 0;
                            break;
                            
                        case 'late_count':
                            data[month-1] = monthRecords.filter(r => r.type === 'late').length;
                            break;
                            
                        case 'leave_early_count':
                            data[month-1] = monthRecords.filter(r => r.type === 'leave_early').length;
                            break;
                            
                        case 'leave_count':
                            data[month-1] = monthRecords.filter(r => 
                                ['sick_leave', 'personal_leave', 'annual_leave'].includes(r.type)
                            ).length;
                            break;
                            
                        case 'rest_count':
                            data[month-1] = monthRecords.filter(r => 
                                r.type === 'o_rest' || r.type === 'b_rest'
                            ).length;
                            break;
                            
                        case 'absent_count':
                            data[month-1] = monthRecords.filter(r => r.type === 'absent').length;
                            break;
                    }
                }
                
                // å›¾è¡¨é…ç½®
                const metricLabels = {
                    'attendance_rate': 'å‡ºå‹¤ç‡ (%)',
                    'late_count': 'è¿Ÿåˆ°æ¬¡æ•°',
                    'leave_early_count': 'æ—©é€€æ¬¡æ•°',
                    'leave_count': 'è¯·å‡æ¬¡æ•°',
                    'rest_count': 'ä¼‘æ¯æ¬¡æ•°',
                    'absent_count': 'ç¼ºå‹¤æ¬¡æ•°'
                };
                
                const colors = {
                    'attendance_rate': '#3498db',
                    'late_count': '#f39c12',
                    'leave_early_count': '#e74c3c',
                    'leave_count': '#9b59b6',
                    'rest_count': '#1abc9c',
                    'absent_count': '#95a5a6'
                };
                
                // é”€æ¯æ—§å›¾è¡¨
                if (yearDimensionChart) {
                    yearDimensionChart.destroy();
                }
                
                yearDimensionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: metricLabels[metric],
                            data: data,
                            backgroundColor: colors[metric],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: metricLabels[metric]
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `${year}å¹´æ¯æœˆ${metricLabels[metric]}å¯¹æ¯”`
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('æ›´æ–°å¹´åº¦çº¬åº¦å›¾è¡¨æ—¶å‡ºé”™:', error);
            }
        }
        
        // ==================== é€šç”¨åŠŸèƒ½ ====================
        // ä¿å­˜æ‰€æœ‰æ•°æ®
        function saveAllData() {
            try {
                // ç¡®ä¿æ•°æ®æ˜¯æ­£ç¡®çš„æ ¼å¼
                if (!Array.isArray(teamMembers)) teamMembers = [];
                if (!Array.isArray(attendanceRecords)) attendanceRecords = [];
                if (!memberSchedules || typeof memberSchedules !== 'object') memberSchedules = {};
                if (!Array.isArray(processes)) processes = [];
                if (!Array.isArray(historyBackup)) historyBackup = [];
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('team_members', JSON.stringify(teamMembers));
                localStorage.setItem('attendance_records', JSON.stringify(attendanceRecords));
                localStorage.setItem('member_schedules', JSON.stringify(memberSchedules));
                localStorage.setItem('processes', JSON.stringify(processes));
                localStorage.setItem('history_backup', JSON.stringify(historyBackup));
                
                // æ›´æ–°æ•°æ®çŠ¶æ€
                dataSaved = true;
                updateDataStatus();
                
                // æ›´æ–°ä»ªè¡¨ç›˜
                updateDashboard();
                
                console.log('âœ… æ•°æ®ä¿å­˜æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ æ•°æ®ä¿å­˜å¤±è´¥:', error);
                dataSaved = false;
                updateDataStatus();
                return false;
            }
        }
        
        // ==================== åˆå§‹åŒ–ç³»ç»Ÿ ====================
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç³»ç»Ÿ
            initSystem();
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const now = DateTime.now();
            document.getElementById('attendanceDate').value = now.toISODate();
            document.getElementById('editDate').value = now.toISODate();
            
            // ç›‘å¬æœç´¢æ¡†
            const searchInput = document.getElementById('searchMember');
            if (searchInput) {
                searchInput.addEventListener('input', renderMemberList);
            }
            
            // åˆå§‹åŒ–è€ƒå‹¤ç±»å‹åˆ‡æ¢
            initAttendanceTypeToggle();
            
            // æ·»åŠ é¡µé¢ç¦»å¼€å‰çš„æ•°æ®ä¿å­˜ç¡®è®¤
            window.addEventListener('beforeunload', function(e) {
                if (!dataSaved) {
                    e.preventDefault();
                    e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                    return 'æ‚¨æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                }
            });
            
            // å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('error', function(event) {
                console.error('å…¨å±€é”™è¯¯:', event.error);
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é”™è¯¯ä¸ŠæŠ¥é€»è¾‘
            });
            
            console.log('âœ… ç³»ç»Ÿå¯åŠ¨å®Œæˆ');
        });
    </script>
</body>
</html>